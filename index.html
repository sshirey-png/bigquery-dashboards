<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Dashboard | FirstLine Schools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'fls-orange': '#e47727',
                        'fls-orange-dark': '#c9621c',
                        'fls-navy': '#002f60',
                        'fls-blue': '#094aad',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Open Sans', system-ui, -apple-system, sans-serif;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #e47727;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive table */
        @media (max-width: 1024px) {
            .desktop-table {
                display: none;
            }
            .mobile-cards {
                display: block;
            }
        }

        @media (min-width: 1025px) {
            .desktop-table {
                display: table;
            }
            .mobile-cards {
                display: none;
            }
        }

        /* Progress bar styling */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e2e8f0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Table row hover */
        .table-row {
            transition: all 0.15s ease;
        }

        .table-row:hover {
            background-color: #f1f5f9;
            cursor: pointer;
        }

        .table-row:hover td:first-child {
            border-left: 3px solid #e47727;
            padding-left: calc(1.5rem - 3px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Segmented control */
        .segmented-control {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 0.75rem;
            padding: 4px;
        }

        .segment-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .segment-btn:hover {
            color: #334155;
        }

        .segment-btn.active {
            background-color: #e47727;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(228, 119, 39, 0.3), 0 1px 2px -1px rgba(228, 119, 39, 0.2);
        }

        /* Avatar gradient */
        .avatar-gradient {
            background: linear-gradient(135deg, #094aad 0%, #002f60 100%);
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Login/Selection Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 p-8">
                <!-- Branded Header -->
                <div class="flex items-center justify-center mb-6">
                    <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png" alt="FirstLine Schools" class="h-16">
                </div>

                <h1 class="text-2xl font-semibold text-fls-navy text-center mb-2">Supervisor Dashboard</h1>
                <p class="text-slate-500 text-center mb-8">Sign in with your FirstLine Schools account</p>

                <!-- Error Messages -->
                <div id="authError" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-red-800" id="authErrorTitle">Authentication Error</p>
                            <p class="text-sm text-red-700 mt-1" id="authErrorMessage"></p>
                        </div>
                    </div>
                </div>

                <!-- Not a Supervisor Warning -->
                <div id="notSupervisorWarning" class="hidden mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-amber-800">Access Limited</p>
                            <p class="text-sm text-amber-700 mt-1">Your account is not associated with a supervisor role. Please contact your administrator if you believe this is an error.</p>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="authLoading" class="hidden mb-6 text-center">
                    <div class="loading mx-auto mb-3"></div>
                    <p class="text-sm text-slate-500">Checking authentication...</p>
                </div>

                <!-- Supervisor Selection (shown after auth for users with multiple supervisors) -->
                <div id="supervisorSelection" class="hidden">
                    <div class="flex items-center gap-2 mb-4">
                        <img id="loginUserPic" src="" alt="" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="text-sm font-medium text-slate-900" id="loginUserName"></p>
                            <p class="text-xs text-slate-500" id="loginUserEmail"></p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="supervisorSelect" class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">
                            Select a Supervisor to View
                        </label>
                        <div class="relative">
                            <select id="supervisorSelect" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 appearance-none focus:outline-none focus:ring-2 focus:ring-fls-orange focus:border-transparent transition-all">
                                <option value="">Select a supervisor...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-xs text-slate-400">You have access to <span id="accessibleCount">0</span> supervisors</p>
                            <button id="refreshSupervisorsBtn" onclick="refreshSupervisorList()" class="text-xs text-slate-400 hover:text-fls-orange flex items-center gap-1 transition-colors" title="Refresh supervisor list">
                                <svg id="refreshIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span id="refreshText">Refresh</span>
                            </button>
                        </div>
                    </div>

                    <button id="viewDashboardBtn" class="w-full bg-fls-orange hover:bg-fls-orange-dark text-white font-semibold py-3 px-4 rounded-full transition-all shadow-lg shadow-fls-orange/30 hover:shadow-fls-orange/40 mb-3">
                        View Dashboard
                    </button>

                    <a href="/logout" class="block text-center text-sm text-slate-500 hover:text-slate-700">
                        Sign out
                    </a>
                </div>

                <!-- Sign In Button -->
                <a href="/login" id="googleSignInBtn" class="flex items-center justify-center gap-3 w-full bg-white hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-full border border-slate-300 transition-all shadow-sm hover:shadow">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </a>

                <p id="signInNote" class="text-xs text-slate-400 text-center mt-4">
                    Only @firstlineschools.org accounts are allowed
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden">
        <!-- Sticky Header -->
        <header class="sticky top-0 z-50 bg-fls-navy border-b border-fls-navy">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png" alt="FirstLine Schools" class="h-10 bg-white rounded px-2 py-1">
                        <div>
                            <h1 class="text-lg font-semibold text-white">Supervisor Dashboard</h1>
                            <p class="text-xs text-orange-200"><span id="currentSupervisorName"></span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- User Profile -->
                        <div class="flex items-center gap-2">
                            <img id="userProfilePic" src="" alt="" class="w-8 h-8 rounded-full hidden">
                            <span id="userDisplayName" class="text-sm text-white hidden"></span>
                        </div>
                        <!-- Change Supervisor (hidden by default, shown for multi-supervisor users) -->
                        <button id="changeSupervisorBtn" class="hidden inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            Change
                        </button>
                        <button id="refreshBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <a href="/logout" id="logoutBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Summary Stats -->
            <div id="summaryStats" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-fls-navy/10 flex items-center justify-center">
                            <svg class="w-5 h-5 text-fls-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total Staff</p>
                            <p class="text-2xl font-semibold text-fls-navy" id="statTotalStaff">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Action Needed</p>
                            <p class="text-2xl font-semibold text-red-500" id="statActionNeeded">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Warnings</p>
                            <p class="text-2xl font-semibold text-amber-500" id="statWarnings">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Good Standing</p>
                            <p class="text-2xl font-semibold text-emerald-500" id="statGoodStanding">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="w-full md:w-56 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" id="searchInput" placeholder="Search staff..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fls-orange focus:border-transparent transition-all">
                    </div>
                    <div class="segmented-control">
                        <button class="segment-btn active" data-filter="all">All Staff</button>
                        <button class="segment-btn" data-filter="alerts">With Alerts</button>
                        <button class="segment-btn" data-filter="action">Action Needed</button>
                    </div>
                    <a href="https://sites.google.com/firstlineschools.org/data-portal/home" target="_blank" class="inline-flex items-center gap-2 px-4 py-2.5 bg-fls-orange text-white font-medium rounded-xl hover:bg-orange-600 transition-colors whitespace-nowrap">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Data Portal
                    </a>
                </div>
            </div>

            <!-- Staff List -->
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <div id="loadingIndicator" class="p-12 text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-slate-500 text-sm">Loading staff data...</p>
                </div>

                <div id="staffTableContainer" class="hidden overflow-x-auto">
                    <table class="desktop-table min-w-full">
                        <thead>
                            <tr class="border-b border-slate-200 bg-slate-50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Staff Member</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Start / Years</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Birthday</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Time Off</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap min-w-[70px]">Total Obs</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Last Obs</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap min-w-[90px]">Action Step</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">PMAPS</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Intent to Return</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody" class="divide-y divide-slate-100">
                        </tbody>
                    </table>

                    <!-- Mobile Cards View -->
                    <div class="mobile-cards p-4 space-y-3" id="staffCardsContainer">
                    </div>
                </div>

                <div id="noDataMessage" class="hidden p-12 text-center">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                    </div>
                    <p class="text-slate-500 text-sm">No staff members found matching your criteria.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail View Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" id="modalBackdrop"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden animate-slide-up">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold text-lg" id="detailAvatar"></div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-900" id="detailName"></h2>
                            <p class="text-sm text-slate-500" id="detailJobTitleHeader"></p>
                        </div>
                    </div>
                    <button id="closeModalBtn" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Alert Banner -->
                    <div id="detailAlertBanner" class="hidden mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-red-800">Action Required</h3>
                                <div id="detailAlertList" class="text-sm text-red-700 mt-1 space-y-1"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Personal Information -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Personal Information</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Email</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailEmail"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Birthday</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailBirthday"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Hire Date</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailHireDate"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Years of Service</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailYearsOfService"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Job Function</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailJobFunction"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Time Off Balances -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Time Off Balances</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">PTO Hours</span>
                                        <span class="font-medium text-slate-900" id="detailPTOHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-fls-orange" id="detailPTOBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Vacation Hours</span>
                                        <span class="font-medium text-slate-900" id="detailVacationHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-emerald-500" id="detailVacationBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Personal Hours</span>
                                        <span class="font-medium text-slate-900" id="detailPersonalHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-violet-500" id="detailPersonalBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Sick Hours</span>
                                        <span class="font-medium text-slate-900" id="detailSickHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-amber-500" id="detailSickBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observations & Performance -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Observations & Performance</h3>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Total Observations</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailTotalObs"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Last Observation</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailLastObsType"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Last Observation Date</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailLastObsDate"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">IAPs/Write-ups</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailDisciplinary"></p>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-slate-200">
                                <p class="text-xs text-slate-500 mb-3">PMAPS Status</p>
                                <div class="flex flex-wrap gap-2" id="detailComplianceChips"></div>
                            </div>
                        </div>

                        <!-- Intent to Return -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Intent to Return</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Intent to Return</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailIntentToReturn"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Response Status</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailIntentDate"></p>
                                </div>
                            </div>
                            <button onclick="closeModal(); showITRDetail(currentDetailEmail);" class="mt-3 text-sm text-fls-orange hover:text-fls-orange-dark font-medium">
                                View Full ITR Details â†’
                            </button>
                        </div>

                        <!-- All Alerts Section -->
                        <div id="detailAlertsSection" class="bg-slate-50 rounded-xl p-4 hidden">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">All Alerts & Notes</h3>
                            <div id="detailAlerts" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-slate-200 px-6 py-4">
                    <button id="closeModalBtnFooter" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ITR Detail Modal -->
    <div id="itrModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" id="itrModalBackdrop"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden animate-slide-up">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">Intent to Return Details</h2>
                        <p class="text-sm text-slate-500" id="itrEmployeeName"></p>
                    </div>
                    <button id="closeItrModalBtn" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Loading State -->
                    <div id="itrLoading" class="p-12 text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-slate-500 text-sm">Loading ITR data...</p>
                    </div>

                    <!-- No Response State -->
                    <div id="itrNoResponse" class="hidden p-12 text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-slate-600 font-medium mb-1">No Response Yet</p>
                        <p class="text-slate-500 text-sm">This employee has not completed the Intent to Return survey.</p>
                    </div>

                    <!-- ITR Data Content -->
                    <div id="itrContent" class="hidden p-6 space-y-4">
                        <!-- Response Status Banner -->
                        <div id="itrStatusBanner" class="p-4 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div id="itrStatusIcon" class="w-10 h-10 rounded-full flex items-center justify-center"></div>
                                <div>
                                    <p class="text-sm font-medium" id="itrStatusText"></p>
                                    <p class="text-xs opacity-75" id="itrResponseDate"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Return Role (if returning) -->
                        <div id="itrReturnRoleSection" class="hidden bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Return Plans</h3>
                            <div class="space-y-2">
                                <div>
                                    <p class="text-xs text-slate-500">Same Role?</p>
                                    <p class="text-sm font-medium text-slate-900" id="itrReturnRole"></p>
                                </div>
                                <div id="itrRolePreferenceSection" class="hidden">
                                    <p class="text-xs text-slate-500">Role Preference</p>
                                    <p class="text-sm font-medium text-slate-900" id="itrRolePreference"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Decision Factors -->
                        <div id="itrDecisionSection" class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Decision Factors</h3>
                            <p class="text-sm text-slate-700" id="itrDecisionFactors"></p>
                        </div>

                        <!-- NPS Score -->
                        <div id="itrNpsSection" class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">NPS Score</h3>
                            <div class="flex items-center gap-3">
                                <div id="itrNpsScoreBadge" class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold"></div>
                                <div>
                                    <p class="text-sm font-medium text-slate-900" id="itrNpsCategory"></p>
                                    <p class="text-xs text-slate-500">Net Promoter Score</p>
                                </div>
                            </div>
                        </div>

                        <!-- Top Factors to Recommend FLS -->
                        <div id="itrRecommendSection" class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Top Factors to Recommend FLS</h3>
                            <p class="text-sm text-slate-700" id="itrTopFactors"></p>
                        </div>

                        <!-- Adult Culture Feedback -->
                        <div id="itrCultureSection" class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Adult Culture Feedback</h3>
                            <p class="text-sm text-slate-700 italic" id="itrCultureFeedback"></p>
                        </div>

                        <!-- Retention Improvement Feedback -->
                        <div id="itrRetentionSection" class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Suggestions to Improve Retention</h3>
                            <p class="text-sm text-slate-700 italic" id="itrRetentionFeedback"></p>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-slate-200 px-6 py-4">
                    <button id="closeItrModalBtnFooter" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Certification Detail Modal -->
    <div id="certModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" id="certModalBackdrop"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden animate-slide-up">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-fls-orange text-white text-lg font-bold flex items-center justify-center">C</div>
                        <div>
                            <h2 class="text-lg font-semibold text-slate-900">Certifications</h2>
                            <p class="text-sm text-slate-500" id="certEmployeeName"></p>
                        </div>
                    </div>
                    <button id="closeCertModalBtn" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Loading State -->
                    <div id="certLoading" class="p-12 text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-slate-500 text-sm">Loading certification data...</p>
                    </div>

                    <!-- No Data State -->
                    <div id="certNoData" class="hidden p-12 text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <p class="text-slate-500 text-sm">No certification data found for this employee.</p>
                    </div>

                    <!-- Certification Content -->
                    <div id="certContent" class="hidden p-6 space-y-4">
                        <!-- Summary Banner -->
                        <div id="certSummaryBanner" class="p-4 rounded-xl bg-emerald-50 border border-emerald-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-emerald-800" id="certSummaryStatus"></p>
                                    <p class="text-xs text-emerald-600" id="certSummaryCount"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Info -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <p class="text-xs text-slate-500">Title</p>
                                    <p class="font-medium text-slate-900" id="certStaffTitle"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">School</p>
                                    <p class="font-medium text-slate-900" id="certStaffSchool"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Active Certifications List -->
                        <div>
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Active Certifications</h3>
                            <div id="certActiveList" class="space-y-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Expired Certifications (if any) -->
                        <div id="certExpiredSection" class="hidden">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Expired Certifications</h3>
                            <div id="certExpiredList" class="space-y-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-slate-200 px-6 py-4">
                    <button id="closeCertModalBtnFooter" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Step Modal -->
    <div id="actionStepModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" onclick="closeActionStepModal()"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
                <!-- Modal Header -->
                <div class="bg-fls-navy text-white px-6 py-4 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="actionStepModalTitle">Action Steps</h2>
                            <p class="text-sm text-white/70" id="actionStepModalSubtitle"></p>
                        </div>
                    </div>
                    <button onclick="closeActionStepModal()" class="w-8 h-8 rounded-lg hover:bg-white/20 flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="bg-slate-50 px-6 py-3 flex gap-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-fls-blue"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepInProgressCount">0</span> In Progress</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepMasteredCount">0</span> Mastered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepNotMasteredCount">0</span> Not Mastered</span>
                    </div>
                </div>

                <!-- Modal Body - Scrollable List -->
                <div class="p-4 space-y-3 overflow-y-auto flex-1" id="actionStepsList">
                    <!-- Action steps will be populated here -->
                </div>

                <!-- Modal Footer -->
                <div class="bg-white border-t border-slate-200 px-6 py-4 flex-shrink-0">
                    <button onclick="closeActionStepModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Observations Detail Modal -->
    <div id="observationsModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" onclick="closeObservationsModal()"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
                <!-- Modal Header -->
                <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="observationsModalTitle">Observations</h2>
                            <p class="text-sm text-white/70" id="observationsModalSubtitle"></p>
                        </div>
                    </div>
                    <button onclick="closeObservationsModal()" class="w-8 h-8 rounded-lg hover:bg-white/20 flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body - Scrollable List -->
                <div class="p-4 space-y-3 overflow-y-auto flex-1" id="observationsList">
                    <!-- Observations will be populated here -->
                </div>

                <!-- Modal Footer -->
                <div class="bg-white border-t border-slate-200 px-6 py-4 flex-shrink-0">
                    <button onclick="closeObservationsModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentSupervisor = '';
        let currentUser = null;
        let staffData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let currentDetailEmail = '';
        let certificationStatus = {}; // email -> cert info for teachers/leaders
        let actionStepsData = {}; // email -> most recent action step

        // API base URL
        const API_BASE = window.location.origin;

        // Deadline configuration by Job_Function
        // Values: Teacher, Leadership, Network, Support, Operations
        // Note: Using Date(year, month-1, day) to avoid timezone issues
        const DEADLINES = {
            'Teacher': {
                sr1: new Date(2025, 10, 17),  // Nov 17, 2025
                pmap1: new Date(2025, 10, 17),
                sr2: new Date(2026, 2, 6),    // Mar 6, 2026
                pmap2: new Date(2026, 2, 6),
                hasSecondRound: true
            },
            'Leadership': {
                sr1: new Date(2025, 7, 29),   // Aug 29, 2025
                pmap1: new Date(2025, 7, 29),
                sr2: new Date(2026, 0, 30),   // Jan 30, 2026
                pmap2: new Date(2026, 0, 30),
                hasSecondRound: true
            },
            'Network': {
                sr1: new Date(2025, 7, 29),   // Aug 29, 2025
                pmap1: new Date(2025, 7, 29),
                sr2: new Date(2026, 0, 30),   // Jan 30, 2026
                pmap2: new Date(2026, 0, 30),
                hasSecondRound: true
            },
            'Support': {
                sr1: new Date(2026, 2, 6),    // Mar 6, 2026
                pmap1: new Date(2026, 2, 6),
                sr2: null,
                pmap2: null,
                hasSecondRound: false
            },
            'Operations': {
                sr1: new Date(2026, 2, 6),    // Mar 6, 2026
                pmap1: new Date(2026, 2, 6),
                sr2: null,
                pmap2: null,
                hasSecondRound: false
            }
        };

        // Get deadlines for a Job_Function (with fallback to Teacher deadlines)
        function getDeadlines(jobFunction) {
            // Try exact match first
            if (DEADLINES[jobFunction]) {
                return DEADLINES[jobFunction];
            }
            // Try case-insensitive partial match
            const lowerType = (jobFunction || '').toLowerCase();
            for (const [key, value] of Object.entries(DEADLINES)) {
                if (lowerType.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerType)) {
                    return value;
                }
            }
            // Default to Teacher deadlines (most common)
            return DEADLINES['Teacher'];
        }

        // Check if a deadline is overdue
        function isOverdue(deadline) {
            if (!deadline) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today > deadline;
        }

        // Format deadline for display
        function formatDeadline(deadline) {
            if (!deadline) return 'N/A';
            return deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            setupEventListeners();
            handleUrlErrors();
        });

        // Check URL for error parameters
        function handleUrlErrors() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const domain = urlParams.get('domain');

            if (error) {
                const errorDiv = document.getElementById('authError');
                const errorTitle = document.getElementById('authErrorTitle');
                const errorMessage = document.getElementById('authErrorMessage');

                if (error === 'unauthorized_domain') {
                    errorTitle.textContent = 'Unauthorized Domain';
                    errorMessage.textContent = `Only @firstlineschools.org accounts are allowed. You signed in with an @${domain || 'unknown'} account.`;
                } else if (error === 'auth_failed') {
                    errorTitle.textContent = 'Authentication Failed';
                    errorMessage.textContent = 'There was a problem signing you in. Please try again.';
                } else if (error === 'session_expired') {
                    errorTitle.textContent = 'Session Expired';
                    errorMessage.textContent = 'Your session has expired. Please sign in again.';
                } else {
                    errorTitle.textContent = 'Error';
                    errorMessage.textContent = 'An unexpected error occurred. Please try again.';
                }

                errorDiv.classList.remove('hidden');
                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Check authentication status
        async function checkAuthStatus() {
            const authLoading = document.getElementById('authLoading');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const signInNote = document.getElementById('signInNote');
            const supervisorSelection = document.getElementById('supervisorSelection');

            try {
                authLoading.classList.remove('hidden');
                googleSignInBtn.classList.add('hidden');
                signInNote.classList.add('hidden');

                const response = await fetch(`${API_BASE}/api/auth/status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                authLoading.classList.add('hidden');

                if (data.authenticated && data.user) {
                    currentUser = data.user;
                    const accessibleSupervisors = data.user.accessible_supervisors || [];

                    // Update user profile in header
                    if (data.user.picture) {
                        const profilePic = document.getElementById('userProfilePic');
                        profilePic.src = data.user.picture;
                        profilePic.classList.remove('hidden');
                    }
                    if (data.user.name) {
                        const displayName = document.getElementById('userDisplayName');
                        displayName.textContent = data.user.name;
                        displayName.classList.remove('hidden');
                    }

                    // Check accessible supervisors
                    if (accessibleSupervisors.length === 0) {
                        // User is authenticated but has no supervisor access
                        document.getElementById('notSupervisorWarning').classList.remove('hidden');
                        googleSignInBtn.textContent = 'Sign in with a different account';
                        googleSignInBtn.classList.remove('hidden');
                    } else if (accessibleSupervisors.length === 1) {
                        // Single supervisor - auto-load dashboard
                        currentSupervisor = accessibleSupervisors[0];
                        document.getElementById('currentSupervisorName').textContent = currentSupervisor;
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('dashboardScreen').classList.remove('hidden');
                        loadStaffData(currentSupervisor);
                    } else {
                        // Multiple supervisors - show selection dropdown
                        showSupervisorSelection(data.user, accessibleSupervisors);
                    }
                } else {
                    // Not authenticated - show sign in button
                    googleSignInBtn.classList.remove('hidden');
                    signInNote.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                authLoading.classList.add('hidden');
                googleSignInBtn.classList.remove('hidden');
                signInNote.classList.remove('hidden');
            }
        }

        // Show supervisor selection for users with multiple accessible supervisors
        function showSupervisorSelection(user, supervisors) {
            const supervisorSelection = document.getElementById('supervisorSelection');
            const loginUserPic = document.getElementById('loginUserPic');
            const loginUserName = document.getElementById('loginUserName');
            const loginUserEmail = document.getElementById('loginUserEmail');
            const supervisorSelect = document.getElementById('supervisorSelect');
            const accessibleCount = document.getElementById('accessibleCount');

            // Set user info
            if (user.picture) {
                loginUserPic.src = user.picture;
            }
            loginUserName.textContent = user.name || 'User';
            loginUserEmail.textContent = user.email || '';
            accessibleCount.textContent = supervisors.length;

            // Populate supervisor dropdown
            supervisorSelect.innerHTML = '<option value="">Select a supervisor...</option>';
            supervisors.forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor;
                option.textContent = supervisor;
                // Pre-select user's own supervisor if they have one
                if (supervisor === user.supervisor_name) {
                    option.selected = true;
                }
                supervisorSelect.appendChild(option);
            });

            // Show the selection UI
            supervisorSelection.classList.remove('hidden');
        }

        // Refresh supervisor list by recalculating from current data
        async function refreshSupervisorList() {
            const refreshBtn = document.getElementById('refreshSupervisorsBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');

            // Show loading state
            refreshBtn.disabled = true;
            refreshIcon.classList.add('animate-spin');
            refreshText.textContent = 'Refreshing...';

            try {
                const response = await fetch(`${API_BASE}/api/refresh-session`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to refresh session');
                }

                const data = await response.json();

                if (data.success) {
                    // Update the supervisor dropdown
                    const supervisorSelect = document.getElementById('supervisorSelect');
                    const accessibleCount = document.getElementById('accessibleCount');
                    const supervisors = data.accessible_supervisors || [];

                    accessibleCount.textContent = supervisors.length;

                    // Preserve current selection if still valid
                    const currentSelection = supervisorSelect.value;

                    supervisorSelect.innerHTML = '<option value="">Select a supervisor...</option>';
                    supervisors.forEach(supervisor => {
                        const option = document.createElement('option');
                        option.value = supervisor;
                        option.textContent = supervisor;
                        if (supervisor === currentSelection || supervisor === data.supervisor_name) {
                            option.selected = true;
                        }
                        supervisorSelect.appendChild(option);
                    });

                    // Show success feedback
                    refreshText.textContent = 'Updated!';
                    setTimeout(() => {
                        refreshText.textContent = 'Refresh';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error refreshing supervisor list:', error);
                refreshText.textContent = 'Error';
                setTimeout(() => {
                    refreshText.textContent = 'Refresh';
                }, 2000);
            } finally {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('animate-spin');
            }
        }

        // Handle view dashboard button click
        function handleViewDashboard() {
            const supervisorSelect = document.getElementById('supervisorSelect');
            const selectedSupervisor = supervisorSelect.value;

            if (!selectedSupervisor) {
                alert('Please select a supervisor to view');
                return;
            }

            currentSupervisor = selectedSupervisor;
            document.getElementById('currentSupervisorName').textContent = currentSupervisor;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');

            // Show "Change" button if user has multiple supervisors
            const accessibleSupervisors = currentUser?.accessible_supervisors || [];
            if (accessibleSupervisors.length > 1) {
                document.getElementById('changeSupervisorBtn').classList.remove('hidden');
            }

            loadStaffData(currentSupervisor);
        }

        // Handle change supervisor button click (go back to selection)
        function handleChangeSupervisor() {
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');

            // Reset state
            currentSupervisor = '';
            staffData = [];
            filteredData = [];

            // Show supervisor selection again
            const accessibleSupervisors = currentUser?.accessible_supervisors || [];
            if (accessibleSupervisors.length > 1) {
                showSupervisorSelection(currentUser, accessibleSupervisors);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('searchInput').addEventListener('input', filterData);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('closeModalBtnFooter').addEventListener('click', closeModal);
            document.getElementById('modalBackdrop').addEventListener('click', closeModal);
            document.getElementById('viewDashboardBtn').addEventListener('click', handleViewDashboard);
            document.getElementById('changeSupervisorBtn').addEventListener('click', handleChangeSupervisor);

            // Filter buttons (segmented control)
            document.querySelectorAll('.segment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentFilter = e.target.dataset.filter;
                    updateFilterButtons();
                    filterData();
                });
            });

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeItrModal();
                    closeCertModal();
                }
            });

            // ITR Modal event listeners
            document.getElementById('closeItrModalBtn').addEventListener('click', closeItrModal);
            document.getElementById('closeItrModalBtnFooter').addEventListener('click', closeItrModal);
            document.getElementById('itrModalBackdrop').addEventListener('click', closeItrModal);

            // Certification Modal event listeners
            document.getElementById('closeCertModalBtn').addEventListener('click', closeCertModal);
            document.getElementById('closeCertModalBtnFooter').addEventListener('click', closeCertModal);
            document.getElementById('certModalBackdrop').addEventListener('click', closeCertModal);
        }

        // Load staff data from API
        async function loadStaffData(supervisor) {
            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('staffTableContainer').classList.add('hidden');
                document.getElementById('noDataMessage').classList.add('hidden');

                // Load staff data, certification status, and action steps in parallel
                const [staffResponse, certResponse, actionStepsResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/staff/${encodeURIComponent(supervisor)}`, {
                        credentials: 'include'
                    }),
                    fetch(`${API_BASE}/api/cert-status`, {
                        credentials: 'include'
                    }),
                    fetch(`${API_BASE}/api/action-steps/${encodeURIComponent(supervisor)}`, {
                        credentials: 'include'
                    })
                ]);

                // Handle authentication errors
                if (staffResponse.status === 401) {
                    // Session expired - redirect to login
                    window.location.href = '/?error=session_expired';
                    return;
                }

                if (staffResponse.status === 403) {
                    // Access denied
                    alert('Access denied. You can only view your own team data.');
                    window.location.href = '/';
                    return;
                }

                if (!staffResponse.ok) throw new Error('Failed to fetch staff data');

                staffData = await staffResponse.json();
                filteredData = [...staffData];

                // Load certification status (non-blocking if fails)
                if (certResponse.ok) {
                    certificationStatus = await certResponse.json();
                } else {
                    certificationStatus = {};
                }

                // Load action steps (non-blocking if fails)
                if (actionStepsResponse.ok) {
                    actionStepsData = await actionStepsResponse.json();
                } else {
                    actionStepsData = {};
                }

                document.getElementById('loadingIndicator').classList.add('hidden');

                if (staffData.length === 0) {
                    document.getElementById('noDataMessage').classList.remove('hidden');
                } else {
                    document.getElementById('staffTableContainer').classList.remove('hidden');
                    updateSummaryStats(staffData);
                    renderListView(filteredData);
                }
            } catch (error) {
                console.error('Error loading staff data:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
                alert('Failed to load staff data. Please try again.');
            }
        }

        // Calculate and update summary stats
        function updateSummaryStats(data) {
            let actionNeeded = 0;
            let warnings = 0;
            let goodStanding = 0;

            data.forEach(staff => {
                const alerts = calculateAlerts(staff);
                if (alerts.level === 'red') actionNeeded++;
                else if (alerts.level === 'yellow') warnings++;
                else goodStanding++;
            });

            document.getElementById('statTotalStaff').textContent = data.length;
            document.getElementById('statActionNeeded').textContent = actionNeeded;
            document.getElementById('statWarnings').textContent = warnings;
            document.getElementById('statGoodStanding').textContent = goodStanding;
        }

        // Refresh data
        function refreshData() {
            if (currentSupervisor) {
                loadStaffData(currentSupervisor);
            }
        }

        // Filter data based on search and filter type
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = staffData.filter(staff => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (staff.Staff_Name || '').toLowerCase().includes(searchTerm);

                // Alert filter
                const alerts = calculateAlerts(staff);
                let matchesFilter = true;

                if (currentFilter === 'alerts') {
                    matchesFilter = alerts.level === 'red' || alerts.level === 'yellow';
                } else if (currentFilter === 'action') {
                    matchesFilter = alerts.level === 'red';
                }

                return matchesSearch && matchesFilter;
            });

            renderListView(filteredData);
        }

        // Update filter button styles (segmented control)
        function updateFilterButtons() {
            document.querySelectorAll('.segment-btn').forEach(btn => {
                if (btn.dataset.filter === currentFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Get avatar initials
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ').filter(p => p.length > 0);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return parts[0] ? parts[0][0].toUpperCase() : '?';
        }

        // Get time off progress percentage (max 80 hours assumed)
        function getTimeOffProgress(hours, maxHours = 80) {
            const num = parseFloat(hours) || 0;
            return Math.min(100, (num / maxHours) * 100);
        }

        // Get certification badge HTML for a staff member
        function getCertBadge(email) {
            if (!email) return '';
            const certInfo = certificationStatus[email.toLowerCase()];
            if (!certInfo || certInfo.status !== 'Certified') return '';

            // Return the orange "C" badge - clickable
            return `<button onclick="event.stopPropagation(); showCertDetail('${email}')"
                class="ml-2 w-5 h-5 rounded bg-fls-orange text-white text-xs font-bold flex items-center justify-center hover:bg-fls-orange-dark transition-colors"
                title="Certified - Click to view certifications">C</button>`;
        }

        // Render list view
        function renderListView(data) {
            const tableBody = document.getElementById('staffTableBody');
            const cardsContainer = document.getElementById('staffCardsContainer');

            tableBody.innerHTML = '';
            cardsContainer.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('staffTableContainer').classList.add('hidden');
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('staffTableContainer').classList.remove('hidden');
            document.getElementById('noDataMessage').classList.add('hidden');

            data.forEach(staff => {
                const alerts = calculateAlerts(staff);
                const yearsOfService = staff.years_of_service ? `${staff.years_of_service}` : 'â€”';
                const initials = getInitials(staff.Staff_Name);
                const timeOffHours = parseFloat(staff.pto_hours_left) || parseFloat(staff.vacation_hours_left) || 0;
                const timeOffProgress = getTimeOffProgress(timeOffHours);
                const timeOffColor = timeOffHours < 20 ? 'bg-red-500' : timeOffHours < 40 ? 'bg-amber-500' : 'bg-emerald-500';

                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.onclick = () => renderDetailView(staff);

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">${initials}</div>
                            <div>
                                <div class="flex items-center font-medium text-slate-900 whitespace-nowrap">${staff.Staff_Name || 'N/A'}${getCertBadge(staff.Email_Address)}</div>
                                <div class="text-xs text-slate-500 whitespace-nowrap">${staff.job_title || 'N/A'}</div>
                                <div class="mt-1">${getEmployeeStatusBadgeSmall(staff.Employment_Status)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-600">${formatDate(staff.Last_Hire_Date)}</div>
                        <div class="text-xs text-slate-400">${yearsOfService} yr${staff.years_of_service === 1 ? '' : 's'}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="text-sm text-slate-600">${formatBirthday(staff.Date_of_Birth)}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="w-20">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-600">${timeOffHours.toFixed(0)}h</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${timeOffColor}" style="width: ${timeOffProgress}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center min-w-[70px]">
                        ${getTotalObsCell(staff.Email_Address, staff.total_observations)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${staff.last_observation_date ? `
                            <div class="text-xs">
                                <span class="font-medium text-slate-700">${formatShortDate(staff.last_observation_date)}</span>
                                <div class="text-slate-400">${staff.last_observation_type || ''}</div>
                            </div>
                        ` : '<span class="text-xs text-slate-400">â€”</span>'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap min-w-[90px]">
                        ${getActionStepCell(staff.Email_Address)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center justify-center gap-1">
                            ${getPmapIconsForStaff(staff)}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <button onclick="event.stopPropagation(); showITRDetail('${staff.Email_Address}')" class="text-sm ${getIntentColor(staff.intent_to_return)} hover:underline cursor-pointer">${getIntentStatus(staff.intent_to_return)}</button>
                    </td>
                `;
                tableBody.appendChild(row);

                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-white border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-slate-300 transition-colors';
                card.onclick = () => renderDetailView(staff);
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold">${initials}</div>
                            <div>
                                <div class="flex items-center font-semibold text-slate-900">${staff.Staff_Name || 'N/A'}${getCertBadge(staff.Email_Address)}</div>
                                <div class="text-sm text-slate-500">${staff.job_title || 'N/A'}</div>
                                <div class="mt-1">${getEmployeeStatusBadgeSmall(staff.Employment_Status)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 mb-3 text-center">
                        <div>
                            <div class="text-sm font-semibold text-slate-900">${formatDate(staff.Last_Hire_Date)}</div>
                            <div class="text-xs text-slate-500">${yearsOfService} yr${staff.years_of_service === 1 ? '' : 's'}</div>
                        </div>
                        <div>
                            <div class="text-lg font-semibold text-slate-900">${formatBirthday(staff.Date_of_Birth)}</div>
                            <div class="text-xs text-slate-500">Birthday</div>
                        </div>
                        <div>
                            <div class="text-lg font-semibold text-slate-900">${staff.total_observations || 0}</div>
                            <div class="text-xs text-slate-500">Total Obs</div>
                        </div>
                        <div onclick="event.stopPropagation(); showITRDetail('${staff.Email_Address}')" class="cursor-pointer">
                            <div class="text-lg font-semibold ${getIntentColor(staff.intent_to_return)}">${getIntentStatus(staff.intent_to_return)}</div>
                            <div class="text-xs text-slate-500">Intent</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <div class="flex items-center gap-1">
                            ${getPmapIconsForStaff(staff)}
                        </div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
        }

        // Get PMAP icon HTML with deadline awareness
        function getPmapIcon(status, label, deadline = null) {
            const complete = isComplete(status);
            const overdue = !complete && isOverdue(deadline);

            if (complete) {
                return `<span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-emerald-50 text-emerald-600" title="${label}: Complete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </span>`;
            }

            // Overdue - show with pulsing red background
            if (overdue) {
                return `<span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-red-100 text-red-600 ring-2 ring-red-300" title="${label}: OVERDUE (was due ${formatDeadline(deadline)})">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </span>`;
            }

            // Not complete but not overdue yet
            return `<span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-amber-50 text-amber-500" title="${label}: Pending (due ${formatDeadline(deadline)})">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </span>`;
        }

        // Get PMAP icons for a staff member based on their user type
        function getPmapIconsForStaff(staff) {
            const userType = staff.Job_Function || '';
            const deadlines = getDeadlines(userType);

            let icons = '';
            icons += getPmapIcon(staff.self_reflection_1_count, 'SR1', deadlines.sr1);
            icons += getPmapIcon(staff.pmap_1_count, 'PMAP1', deadlines.pmap1);

            // Only show SR2/PMAP2 if this user type has them
            if (deadlines.hasSecondRound) {
                icons += getPmapIcon(staff.self_reflection_2_count, 'SR2', deadlines.sr2);
                icons += getPmapIcon(staff.pmap_2_count, 'PMAP2', deadlines.pmap2);
            }

            return icons;
        }

        // Get employee status badge HTML (actual status from data)
        function getEmployeeStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();
            let colors, text;

            if (statusLower === 'active' || statusLower === 'employed') {
                colors = 'bg-emerald-50 text-emerald-700 border-emerald-200';
                text = 'Active';
            } else if (statusLower === 'on leave' || statusLower === 'leave' || statusLower === 'leave of absence') {
                colors = 'bg-amber-50 text-amber-700 border-amber-200';
                text = 'On Leave';
            } else if (statusLower === 'terminated' || statusLower === 'inactive') {
                colors = 'bg-red-50 text-red-700 border-red-200';
                text = 'Inactive';
            } else if (statusLower === 'pending') {
                colors = 'bg-fls-navy/10 text-fls-navy border-fls-navy/20';
                text = 'Pending';
            } else {
                colors = 'bg-slate-50 text-slate-600 border-slate-200';
                text = status || 'â€”';
            }

            return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${colors}">${text}</span>`;
        }

        // Get employee status badge HTML - smaller version for inline display
        function getEmployeeStatusBadgeSmall(status) {
            const statusLower = (status || '').toLowerCase();
            let colors, text;

            if (statusLower === 'active' || statusLower === 'employed') {
                colors = 'bg-emerald-50 text-emerald-700';
                text = 'Active';
            } else if (statusLower === 'on leave' || statusLower === 'leave' || statusLower === 'leave of absence') {
                colors = 'bg-amber-50 text-amber-700';
                text = 'On Leave';
            } else if (statusLower === 'terminated' || statusLower === 'inactive') {
                colors = 'bg-red-50 text-red-700';
                text = 'Inactive';
            } else if (statusLower === 'pending') {
                colors = 'bg-slate-100 text-slate-600';
                text = 'Pending';
            } else {
                colors = 'bg-slate-50 text-slate-500';
                text = status || 'â€”';
            }

            return `<span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium ${colors}">${text}</span>`;
        }

        // Get action step status text and color
        function getActionStepStatus(progress_percent) {
            if (progress_percent === 100) {
                return { text: 'Mastered', bgColor: 'bg-emerald-500', textColor: 'text-emerald-600' };
            } else if (progress_percent === 0) {
                return { text: 'In Progress', bgColor: 'bg-fls-blue', textColor: 'text-fls-blue' };
            } else if (progress_percent === -1 || progress_percent === -10) {
                return { text: 'Not Mastered', bgColor: 'bg-red-500', textColor: 'text-red-600' };
            }
            return { text: 'Unknown', bgColor: 'bg-slate-300', textColor: 'text-slate-600' };
        }

        // Get action step cell HTML
        function getActionStepCell(email) {
            const actionSteps = actionStepsData[email.toLowerCase()];

            if (!actionSteps || actionSteps.length === 0) {
                return `<span class="text-xs text-slate-400">â€”</span>`;
            }

            // Count in-progress steps (progress_percent = 0)
            const inProgressCount = actionSteps.filter(s => s.progress_percent === 0).length;
            const totalCount = actionSteps.length;

            return `
                <button onclick="event.stopPropagation(); showActionStepModal('${email}')"
                    class="text-left hover:bg-slate-50 rounded-lg p-1 -m-1 transition-colors">
                    <div class="flex items-center gap-1.5">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-fls-blue text-white text-xs font-bold">${inProgressCount}</span>
                        <span class="text-xs text-slate-500">of ${totalCount}</span>
                    </div>
                </button>
            `;
        }

        // Show action step modal
        function showActionStepModal(email) {
            const actionSteps = actionStepsData[email.toLowerCase()];
            const modal = document.getElementById('actionStepModal');

            if (!actionSteps || actionSteps.length === 0) {
                return;
            }

            // Get staff name from first action step
            const staffName = actionSteps[0].user_name || 'Staff Member';
            document.getElementById('actionStepModalTitle').textContent = staffName;
            document.getElementById('actionStepModalSubtitle').textContent = `${actionSteps.length} Action Step${actionSteps.length !== 1 ? 's' : ''} This Year`;

            // Count by status
            const inProgressCount = actionSteps.filter(s => s.progress_percent === 0).length;
            const masteredCount = actionSteps.filter(s => s.progress_percent === 100).length;
            const notMasteredCount = actionSteps.filter(s => s.progress_percent === -1 || s.progress_percent === -10).length;

            document.getElementById('actionStepInProgressCount').textContent = inProgressCount;
            document.getElementById('actionStepMasteredCount').textContent = masteredCount;
            document.getElementById('actionStepNotMasteredCount').textContent = notMasteredCount;

            // Build action steps list HTML
            const listContainer = document.getElementById('actionStepsList');
            listContainer.innerHTML = actionSteps.map(step => {
                const status = getActionStepStatus(step.progress_percent);
                const tagsHtml = step.tags
                    ? step.tags.split(', ').map(tag =>
                        `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-slate-100 text-slate-600">${tag}</span>`
                      ).join('')
                    : '';

                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-slate-300 transition-colors">
                        <div class="flex items-start justify-between gap-3 mb-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status.bgColor} text-white">${status.text}</span>
                            <span class="text-xs text-slate-400">${formatShortDate(step.created)}</span>
                        </div>
                        <p class="text-sm text-slate-800 leading-relaxed mb-2">${step.name || 'No description'}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-wrap gap-1">${tagsHtml}</div>
                            <span class="text-xs text-slate-400">by ${step.creator_name || 'Unknown'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            modal.classList.remove('hidden');
        }

        // Close action step modal
        function closeActionStepModal() {
            document.getElementById('actionStepModal').classList.add('hidden');
        }

        // Get total observations cell HTML
        function getTotalObsCell(email, totalObs) {
            const count = totalObs || 0;

            if (count === 0) {
                return `<span class="text-sm text-slate-400">0</span>`;
            }

            return `
                <button onclick="event.stopPropagation(); showObservationsModal('${email}')"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold text-sm transition-colors">
                    ${count}
                </button>
            `;
        }

        // Show observations modal
        async function showObservationsModal(email) {
            const modal = document.getElementById('observationsModal');
            const listContainer = document.getElementById('observationsList');

            // Get staff info
            const staffMember = staffData.find(s => s.Email_Address && s.Email_Address.toLowerCase() === email.toLowerCase());
            const staffName = staffMember ? staffMember.Staff_Name : 'Staff Member';

            document.getElementById('observationsModalTitle').textContent = staffName;
            document.getElementById('observationsModalSubtitle').textContent = 'Loading observations...';
            listContainer.innerHTML = '<div class="text-center py-8"><div class="loading mx-auto"></div></div>';

            modal.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/observations/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch observations');
                }

                const observations = await response.json();

                document.getElementById('observationsModalSubtitle').textContent = `${observations.length} Observation${observations.length !== 1 ? 's' : ''} This Year`;

                if (observations.length === 0) {
                    listContainer.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <p>No observations recorded this school year</p>
                        </div>
                    `;
                    return;
                }

                // Group by observation type
                const byType = {};
                observations.forEach(obs => {
                    const type = obs.observation_type || 'Other';
                    if (!byType[type]) byType[type] = [];
                    byType[type].push(obs);
                });

                let html = '';
                for (const [type, obs] of Object.entries(byType)) {
                    const typeColor = type.includes('Self') ? 'bg-purple-500' :
                                     type.includes('PMAP') ? 'bg-emerald-500' : 'bg-blue-500';

                    obs.forEach(o => {
                        html += `
                            <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-slate-300 transition-colors">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeColor} text-white">${o.observation_type || 'Observation'}</span>
                                    <span class="text-xs text-slate-400">${formatShortDate(o.observed_at)}</span>
                                </div>
                                <p class="text-sm text-slate-700 mb-1">${o.rubric_form || 'Standard Observation'}</p>
                                <div class="flex items-center justify-between text-xs text-slate-400">
                                    <span>${o.school || ''}</span>
                                    <span>by ${o.observer_name || 'Unknown'}</span>
                                </div>
                                ${o.link ? `<a href="${o.link}" target="_blank" class="inline-flex items-center gap-1 mt-2 text-xs text-fls-blue hover:underline">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                    View in Grow
                                </a>` : ''}
                            </div>
                        `;
                    });
                }

                listContainer.innerHTML = html;

            } catch (error) {
                console.error('Error loading observations:', error);
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>Failed to load observations</p>
                    </div>
                `;
            }
        }

        // Close observations modal
        function closeObservationsModal() {
            document.getElementById('observationsModal').classList.add('hidden');
        }

        // Format birthday as month/day only
        function formatBirthday(dateStr) {
            if (!dateStr) return 'â€”';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } catch {
                return 'â€”';
            }
        }

        // Format short date (for last observation)
        function formatShortDate(dateStr) {
            if (!dateStr) return 'â€”';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
            } catch {
                return 'â€”';
            }
        }

        // Get intent color class
        function getIntentColor(intent) {
            if (!intent) return 'text-slate-500';
            const str = String(intent).toLowerCase();
            if (str === 'yes') return 'text-emerald-600 font-medium';
            if (str === 'no') return 'text-red-600 font-medium';
            if (str === 'unsure') return 'text-amber-600 font-medium';
            return 'text-slate-500';
        }

        // Render detail view modal
        function renderDetailView(staff) {
            // Store email for ITR detail link
            currentDetailEmail = staff.Email_Address || '';

            const initials = getInitials(staff.Staff_Name);
            document.getElementById('detailAvatar').textContent = initials;
            document.getElementById('detailName').textContent = staff.Staff_Name || 'N/A';
            document.getElementById('detailJobTitleHeader').textContent = staff.job_title || 'N/A';
            document.getElementById('detailEmail').textContent = staff.Email_Address || 'N/A';
            document.getElementById('detailBirthday').textContent = formatDate(staff.Date_of_Birth);
            document.getElementById('detailHireDate').textContent = formatDate(staff.Last_Hire_Date);
            document.getElementById('detailYearsOfService').textContent = staff.years_of_service ? `${staff.years_of_service} years` : 'N/A';
            document.getElementById('detailJobFunction').textContent = staff.Job_Function || 'N/A';

            // Time off with progress bars
            const ptoHours = parseFloat(staff.pto_hours_left) || 0;
            const vacationHours = parseFloat(staff.vacation_hours_left) || 0;
            const personalHours = parseFloat(staff.personal_hours_left) || 0;
            const sickHours = parseFloat(staff.sick_hours_left) || 0;

            document.getElementById('detailPTOHours').textContent = formatHours(staff.pto_hours_left);
            document.getElementById('detailVacationHours').textContent = formatHours(staff.vacation_hours_left);
            document.getElementById('detailPersonalHours').textContent = formatHours(staff.personal_hours_left);
            document.getElementById('detailSickHours').textContent = formatHours(staff.sick_hours_left);

            document.getElementById('detailPTOBar').style.width = `${getTimeOffProgress(ptoHours)}%`;
            document.getElementById('detailVacationBar').style.width = `${getTimeOffProgress(vacationHours)}%`;
            document.getElementById('detailPersonalBar').style.width = `${getTimeOffProgress(personalHours, 24)}%`;
            document.getElementById('detailSickBar').style.width = `${getTimeOffProgress(sickHours, 40)}%`;

            document.getElementById('detailTotalObs').textContent = staff.total_observations || '0';
            document.getElementById('detailLastObsType').textContent = staff.last_observation_type || 'N/A';
            document.getElementById('detailLastObsDate').textContent = formatDate(staff.last_observation_date);
            document.getElementById('detailDisciplinary').textContent =
                `${staff.iap_count || 0} IAPs, ${staff.writeup_count || 0} Write-ups`;

            // PMAP chips - user type aware
            const chipsContainer = document.getElementById('detailComplianceChips');
            chipsContainer.innerHTML = '';

            const userType = staff.Job_Function || '';
            const deadlines = getDeadlines(userType);

            const pmapItems = [
                { label: 'SR1', complete: isComplete(staff.self_reflection_1_count), deadline: deadlines.sr1 },
                { label: 'PMAP1', complete: isComplete(staff.pmap_1_count), deadline: deadlines.pmap1 }
            ];

            // Only add SR2/PMAP2 if this user type has them
            if (deadlines.hasSecondRound) {
                pmapItems.push(
                    { label: 'SR2', complete: isComplete(staff.self_reflection_2_count), deadline: deadlines.sr2 },
                    { label: 'PMAP2', complete: isComplete(staff.pmap_2_count), deadline: deadlines.pmap2 }
                );
            }

            pmapItems.forEach(item => {
                const overdue = !item.complete && isOverdue(item.deadline);
                let chipClass, icon, statusText;

                if (item.complete) {
                    chipClass = 'bg-emerald-50 text-emerald-700 border-emerald-200';
                    icon = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    statusText = 'Complete';
                } else if (overdue) {
                    chipClass = 'bg-red-100 text-red-700 border-red-300 ring-1 ring-red-300';
                    icon = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                    statusText = `OVERDUE`;
                } else {
                    chipClass = 'bg-amber-50 text-amber-700 border-amber-200';
                    icon = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    statusText = `Due ${formatDeadline(item.deadline)}`;
                }

                const chip = document.createElement('div');
                chip.className = `inline-flex flex-col items-center gap-1 px-3 py-2 rounded-lg text-xs font-medium border ${chipClass}`;
                chip.innerHTML = `
                    <div class="flex items-center gap-1.5">
                        ${icon} ${item.label}
                    </div>
                    <span class="text-[10px] opacity-80">${statusText}</span>
                `;
                chipsContainer.appendChild(chip);
            });

            document.getElementById('detailIntentToReturn').textContent = staff.intent_to_return || 'N/A';
            document.getElementById('detailIntentDate').textContent = staff.intent_response_status || 'N/A';

            // Render alerts
            const alerts = calculateAlerts(staff);
            const alertBanner = document.getElementById('detailAlertBanner');
            const alertList = document.getElementById('detailAlertList');
            const alertsSection = document.getElementById('detailAlertsSection');
            const alertsContainer = document.getElementById('detailAlerts');

            // Show alert banner if there are red alerts
            const redAlerts = alerts.items.filter(a => a.level === 'red');
            if (redAlerts.length > 0) {
                alertBanner.classList.remove('hidden');
                alertList.innerHTML = redAlerts.map(a => `<p>â€¢ ${a.message}</p>`).join('');
            } else {
                alertBanner.classList.add('hidden');
            }

            // Show all alerts section if there are any alerts
            alertsContainer.innerHTML = '';
            if (alerts.items.length === 0) {
                alertsSection.classList.add('hidden');
            } else {
                alertsSection.classList.remove('hidden');
                alerts.items.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    const alertColors = {
                        red: 'bg-red-50 border-red-200 text-red-700',
                        yellow: 'bg-amber-50 border-amber-200 text-amber-700',
                        green: 'bg-emerald-50 border-emerald-200 text-emerald-700'
                    };
                    alertDiv.className = `p-3 rounded-lg border text-sm ${alertColors[alert.level]}`;
                    alertDiv.textContent = alert.message;
                    alertsContainer.appendChild(alertDiv);
                });
            }

            document.getElementById('detailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Show ITR Detail Modal
        async function showITRDetail(email) {
            if (!email) return;

            const modal = document.getElementById('itrModal');
            const loading = document.getElementById('itrLoading');
            const noResponse = document.getElementById('itrNoResponse');
            const content = document.getElementById('itrContent');

            // Show modal with loading state
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            loading.classList.remove('hidden');
            noResponse.classList.add('hidden');
            content.classList.add('hidden');

            // Find staff name from current data
            const staffMember = staffData.find(s => s.Email_Address === email);
            const staffName = staffMember ? staffMember.Staff_Name : email;
            document.getElementById('itrEmployeeName').textContent = staffName;

            try {
                const response = await fetch(`${API_BASE}/api/itr-detail/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });

                loading.classList.add('hidden');

                if (response.status === 404) {
                    // No ITR data found
                    noResponse.classList.remove('hidden');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch ITR data');
                }

                const data = await response.json();
                renderITRDetail(data);
                content.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching ITR detail:', error);
                loading.classList.add('hidden');
                noResponse.classList.remove('hidden');
            }
        }

        // Render ITR detail data
        function renderITRDetail(data) {
            // Status banner
            const statusBanner = document.getElementById('itrStatusBanner');
            const statusIcon = document.getElementById('itrStatusIcon');
            const statusText = document.getElementById('itrStatusText');
            const responseDate = document.getElementById('itrResponseDate');

            const intent = (data.intent_to_return || '').toLowerCase();
            let bannerColors, iconHtml, statusLabel;

            if (intent === 'yes') {
                bannerColors = 'bg-emerald-50 border border-emerald-200';
                iconHtml = '<svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                statusIcon.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-emerald-100';
                statusLabel = 'Intends to Return';
            } else if (intent === 'no') {
                bannerColors = 'bg-red-50 border border-red-200';
                iconHtml = '<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                statusIcon.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-red-100';
                statusLabel = 'Not Returning';
            } else {
                bannerColors = 'bg-amber-50 border border-amber-200';
                iconHtml = '<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                statusIcon.className = 'w-10 h-10 rounded-full flex items-center justify-center bg-amber-100';
                statusLabel = 'Unsure / Undecided';
            }

            statusBanner.className = `p-4 rounded-xl ${bannerColors}`;
            statusIcon.innerHTML = iconHtml;
            statusText.textContent = statusLabel;
            responseDate.textContent = data.response_date ? `Responded: ${formatDate(data.response_date)}` : '';

            // Return Role Section (show only if returning)
            const returnRoleSection = document.getElementById('itrReturnRoleSection');
            const rolePreferenceSection = document.getElementById('itrRolePreferenceSection');

            if (intent === 'yes' && data.return_role) {
                returnRoleSection.classList.remove('hidden');
                document.getElementById('itrReturnRole').textContent = data.return_role;

                if (data.return_role_preference || data.return_role_preference_other) {
                    rolePreferenceSection.classList.remove('hidden');
                    document.getElementById('itrRolePreference').textContent =
                        data.return_role_preference_other || data.return_role_preference || 'N/A';
                } else {
                    rolePreferenceSection.classList.add('hidden');
                }
            } else {
                returnRoleSection.classList.add('hidden');
            }

            // Decision Factors
            const decisionSection = document.getElementById('itrDecisionSection');
            if (data.decision_factors) {
                decisionSection.classList.remove('hidden');
                document.getElementById('itrDecisionFactors').textContent = data.decision_factors;
            } else {
                decisionSection.classList.add('hidden');
            }

            // NPS Score
            const npsSection = document.getElementById('itrNpsSection');
            if (data.nps_score !== null && data.nps_score !== undefined) {
                npsSection.classList.remove('hidden');
                const npsBadge = document.getElementById('itrNpsScoreBadge');
                const npsCategory = document.getElementById('itrNpsCategory');

                let npsColors;
                if (data.nps_score >= 9) {
                    npsColors = 'bg-emerald-100 text-emerald-700';
                    npsCategory.textContent = 'Promoter';
                } else if (data.nps_score >= 7) {
                    npsColors = 'bg-amber-100 text-amber-700';
                    npsCategory.textContent = 'Passive';
                } else {
                    npsColors = 'bg-red-100 text-red-700';
                    npsCategory.textContent = 'Detractor';
                }

                npsBadge.className = `w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold ${npsColors}`;
                npsBadge.textContent = data.nps_score;
            } else {
                npsSection.classList.add('hidden');
            }

            // Top Factors to Recommend FLS
            const recommendSection = document.getElementById('itrRecommendSection');
            if (data.top_factors_recommend_fls) {
                recommendSection.classList.remove('hidden');
                document.getElementById('itrTopFactors').textContent = data.top_factors_recommend_fls;
            } else {
                recommendSection.classList.add('hidden');
            }

            // Adult Culture Feedback
            const cultureSection = document.getElementById('itrCultureSection');
            if (data.adult_culture_feedback && data.adult_culture_feedback.toLowerCase() !== 'n/a') {
                cultureSection.classList.remove('hidden');
                document.getElementById('itrCultureFeedback').textContent = `"${data.adult_culture_feedback}"`;
            } else {
                cultureSection.classList.add('hidden');
            }

            // Retention Improvement Feedback
            const retentionSection = document.getElementById('itrRetentionSection');
            if (data.improve_retention_feedback && data.improve_retention_feedback.toLowerCase() !== 'n/a') {
                retentionSection.classList.remove('hidden');
                document.getElementById('itrRetentionFeedback').textContent = `"${data.improve_retention_feedback}"`;
            } else {
                retentionSection.classList.add('hidden');
            }
        }

        // Close ITR modal
        function closeItrModal() {
            document.getElementById('itrModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Show Certification Detail Modal
        async function showCertDetail(email) {
            if (!email) return;

            const modal = document.getElementById('certModal');
            const loading = document.getElementById('certLoading');
            const noData = document.getElementById('certNoData');
            const content = document.getElementById('certContent');

            // Show modal with loading state
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            loading.classList.remove('hidden');
            noData.classList.add('hidden');
            content.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/cert-detail/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });

                loading.classList.add('hidden');

                if (response.status === 404) {
                    noData.classList.remove('hidden');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch certification data');
                }

                const data = await response.json();
                renderCertDetail(data);

            } catch (error) {
                console.error('Error fetching certification detail:', error);
                loading.classList.add('hidden');
                noData.classList.remove('hidden');
            }
        }

        // Render certification detail data
        function renderCertDetail(data) {
            const content = document.getElementById('certContent');
            content.classList.remove('hidden');

            // Employee name in header
            document.getElementById('certEmployeeName').textContent = data.name || '';

            // Summary status
            document.getElementById('certSummaryStatus').textContent =
                data.certification_status === 'Certified' ? 'State Certified' : data.certification_status;
            document.getElementById('certSummaryCount').textContent =
                `${data.active_certifications || 0} active certification${data.active_certifications !== 1 ? 's' : ''}`;

            // Staff info
            document.getElementById('certStaffTitle').textContent = data.title || 'N/A';
            document.getElementById('certStaffSchool').textContent = data.school || 'N/A';

            // Build active certifications list
            const activeList = document.getElementById('certActiveList');
            const activeCerts = (data.certifications || []).filter(c => c.status === 'Active' && c.expiration_status !== 'Expired');

            if (activeCerts.length > 0) {
                activeList.innerHTML = activeCerts.map(cert => `
                    <div class="bg-white border border-slate-200 rounded-xl p-3">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-slate-900 text-sm">${cert.qualification || 'Unknown'}</p>
                                <p class="text-xs text-slate-500">${cert.category || ''}</p>
                            </div>
                            ${getCertExpirationBadge(cert)}
                        </div>
                        <div class="mt-2 flex gap-4 text-xs text-slate-500">
                            <span>Earned: ${formatDateShort(cert.earn_date)}</span>
                            <span>Expires: ${formatDateShort(cert.expire_date)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                activeList.innerHTML = '<p class="text-sm text-slate-500 italic">No active certifications</p>';
            }

            // Build expired certifications list (if any)
            const expiredSection = document.getElementById('certExpiredSection');
            const expiredList = document.getElementById('certExpiredList');
            const expiredCerts = (data.certifications || []).filter(c => c.status !== 'Active' || c.expiration_status === 'Expired');

            if (expiredCerts.length > 0) {
                expiredSection.classList.remove('hidden');
                expiredList.innerHTML = expiredCerts.map(cert => `
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 opacity-75">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-slate-700 text-sm">${cert.qualification || 'Unknown'}</p>
                                <p class="text-xs text-slate-500">${cert.category || ''}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-600">Expired</span>
                        </div>
                        <div class="mt-2 flex gap-4 text-xs text-slate-400">
                            <span>Earned: ${formatDateShort(cert.earn_date)}</span>
                            <span>Expired: ${formatDateShort(cert.expire_date)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                expiredSection.classList.add('hidden');
            }
        }

        // Get expiration badge for certification
        function getCertExpirationBadge(cert) {
            if (!cert.expire_date) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">No Expiration</span>';
            }

            const days = cert.days_until_expiration;
            if (days === null || days === undefined) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Current</span>';
            }

            if (days < 0) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-700">Expired</span>';
            } else if (days <= 90) {
                return `<span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">${days} days</span>`;
            } else {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Current</span>';
            }
        }

        // Format date for display (short format)
        function formatDateShort(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        // Close Certification modal
        function closeCertModal() {
            document.getElementById('certModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Calculate alerts for a staff member (deadline-aware)
        function calculateAlerts(staff) {
            const alerts = [];
            const userType = staff.Job_Function || '';
            const deadlines = getDeadlines(userType);

            // Check SR1 observation
            if (!isComplete(staff.self_reflection_1_count)) {
                if (isOverdue(deadlines.sr1)) {
                    alerts.push({ level: 'red', message: `SR1 OVERDUE (was due ${formatDeadline(deadlines.sr1)})` });
                } else {
                    alerts.push({ level: 'yellow', message: `SR1 pending (due ${formatDeadline(deadlines.sr1)})` });
                }
            }

            // Check PMAP1 observation
            if (!isComplete(staff.pmap_1_count)) {
                if (isOverdue(deadlines.pmap1)) {
                    alerts.push({ level: 'red', message: `PMAP1 OVERDUE (was due ${formatDeadline(deadlines.pmap1)})` });
                } else {
                    alerts.push({ level: 'yellow', message: `PMAP1 pending (due ${formatDeadline(deadlines.pmap1)})` });
                }
            }

            // Only check SR2/PMAP2 if this user type requires them
            if (deadlines.hasSecondRound) {
                if (!isComplete(staff.self_reflection_2_count)) {
                    if (isOverdue(deadlines.sr2)) {
                        alerts.push({ level: 'red', message: `SR2 OVERDUE (was due ${formatDeadline(deadlines.sr2)})` });
                    } else {
                        alerts.push({ level: 'yellow', message: `SR2 pending (due ${formatDeadline(deadlines.sr2)})` });
                    }
                }

                if (!isComplete(staff.pmap_2_count)) {
                    if (isOverdue(deadlines.pmap2)) {
                        alerts.push({ level: 'red', message: `PMAP2 OVERDUE (was due ${formatDeadline(deadlines.pmap2)})` });
                    } else {
                        alerts.push({ level: 'yellow', message: `PMAP2 pending (due ${formatDeadline(deadlines.pmap2)})` });
                    }
                }
            }

            // Check intent to return
            const intent = (staff.intent_to_return || '').toLowerCase();
            if (intent === 'no') {
                alerts.push({ level: 'red', message: 'Staff member does not intend to return' });
            } else if (!intent || intent === 'pending' || intent === '' || intent === 'n/a') {
                alerts.push({ level: 'yellow', message: 'Intent to return status pending' });
            }

            // Check PTO balance
            const ptoHours = parseFloat(staff.pto_hours_left) || parseFloat(staff.vacation_hours_left) || 0;
            if (ptoHours < 20) {
                alerts.push({ level: 'red', message: `Low time off balance (${ptoHours.toFixed(1)} hours)` });
            } else if (ptoHours < 40) {
                alerts.push({ level: 'yellow', message: `Medium time off balance (${ptoHours.toFixed(1)} hours)` });
            }

            // Check disciplinary actions
            const iapCount = parseInt(staff.iap_count) || 0;
            const writeupCount = parseInt(staff.writeup_count) || 0;
            if (iapCount > 0 || writeupCount > 0) {
                alerts.push({ level: 'yellow', message: `${iapCount} IAPs, ${writeupCount} write-ups on record` });
            }

            // Determine overall level
            let level = 'green';
            if (alerts.some(a => a.level === 'red')) {
                level = 'red';
            } else if (alerts.some(a => a.level === 'yellow')) {
                level = 'yellow';
            }

            const text = level === 'green' ? 'Good' : level === 'yellow' ? 'Warning' : 'Action Needed';

            return { level, text, items: alerts };
        }

        // Helper functions
        function isComplete(count) {
            // For counts: > 0 means complete, 0 or null means incomplete
            if (count === null || count === undefined) return false;
            const num = parseInt(count);
            return !isNaN(num) && num > 0;
        }

        function getIntentStatus(status) {
            if (!status) return 'Pending';
            const str = String(status).trim();
            // Return the actual value (Yes, No, Unsure, etc.)
            return str;
        }

        function formatHours(hours) {
            const num = parseFloat(hours);
            return isNaN(num) ? 'N/A' : `${num.toFixed(1)}h`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return 'N/A';
            }
        }
    </script>
</body>
</html>
