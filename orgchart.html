<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart | FirstLine Schools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'fls-orange': '#e47727',
                        'fls-orange-dark': '#c9621c',
                        'fls-navy': '#002f60',
                        'fls-blue': '#094aad',
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Open Sans', system-ui, -apple-system, sans-serif;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #e47727;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .tab-btn:hover {
            color: #002f60;
            background: white;
        }

        .tab-btn.active {
            background: #002f60;
            color: white;
            box-shadow: 0 2px 4px rgba(0,47,96,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Google Charts styling overrides */
        .google-visualization-orgchart-node {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #002f60;
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'Open Sans', sans-serif;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .google-visualization-orgchart-node-medium {
            font-size: 13px;
        }

        /* Page title */
        .page-title {
            text-align: center;
            margin-bottom: 10px;
        }

        .page-title h2 {
            font-size: 28px;
            font-weight: 700;
            color: #002f60;
        }

        .page-title p {
            color: #64748b;
            font-size: 14px;
        }

        .chart-container {
            width: 100%;
            overflow-x: auto;
            padding: 20px 0;
        }

        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-fls-navy text-white shadow-lg no-print">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png"
                         alt="FirstLine Schools" class="h-10 bg-white rounded px-2 py-1">
                    <div>
                        <h1 class="text-xl font-bold">Organization Chart</h1>
                        <p class="text-sm text-gray-300">Leadership & Management Structure</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors">
                        Back to Dashboard
                    </a>
                    <button onclick="window.print()" class="px-4 py-2 bg-fls-orange hover:bg-fls-orange-dark rounded-lg text-sm transition-colors">
                        Print
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="bg-white border-b sticky top-0 z-40 no-print">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <nav class="tab-nav" id="tabNav">
                <button class="tab-btn active" data-tab="c-team">C-Team</button>
                <button class="tab-btn" data-tab="operations">Operations Team</button>
                <button class="tab-btn" data-tab="devcomm">Dev/Comm Team</button>
                <button class="tab-btn" data-tab="hr-talent">HR/Talent Team</button>
                <button class="tab-btn" data-tab="schools">Schools Team</button>
                <button class="tab-btn" data-tab="directors">School Directors</button>
            </nav>
        </div>
    </div>

    <!-- Loading state -->
    <div id="loadingState" class="flex flex-col items-center justify-center py-20">
        <div class="loading mb-4"></div>
        <p class="text-gray-600">Loading organization chart...</p>
    </div>

    <!-- Error state -->
    <div id="errorState" class="hidden flex flex-col items-center justify-center py-20">
        <div class="text-red-500 text-6xl mb-4">!</div>
        <p class="text-gray-800 font-semibold mb-2">Failed to load organization data</p>
        <p id="errorMessage" class="text-gray-600 mb-4"></p>
        <button onclick="loadOrgData()" class="px-4 py-2 bg-fls-orange text-white rounded-lg hover:bg-fls-orange-dark">
            Try Again
        </button>
    </div>

    <!-- Tab Content Container -->
    <div id="tabContent" class="hidden max-w-7xl mx-auto px-4 py-8">

        <!-- C-Team -->
        <div class="tab-content active" id="tab-c-team">
            <div class="page-title">
                <h2>C-Team</h2>
                <p>Executive Leadership</p>
            </div>
            <div class="chart-container" id="chart-c-team"></div>
        </div>

        <!-- Operations Team -->
        <div class="tab-content" id="tab-operations">
            <div class="page-title">
                <h2>Operations Team</h2>
                <p>Operations, Finance & Technology</p>
            </div>
            <div class="chart-container" id="chart-operations"></div>
        </div>

        <!-- Dev/Comm Team -->
        <div class="tab-content" id="tab-devcomm">
            <div class="page-title">
                <h2>Dev/Comm Team</h2>
                <p>Development & Communications</p>
            </div>
            <div class="chart-container" id="chart-devcomm"></div>
        </div>

        <!-- HR/Talent Team -->
        <div class="tab-content" id="tab-hr-talent">
            <div class="page-title">
                <h2>HR/Talent Team</h2>
                <p>Human Resources & Talent Management</p>
            </div>
            <div class="chart-container" id="chart-hr-talent"></div>
        </div>

        <!-- Schools Team -->
        <div class="tab-content" id="tab-schools">
            <div class="page-title">
                <h2>Schools Team</h2>
                <p>School Leadership & Academics</p>
            </div>
            <div class="chart-container" id="chart-schools"></div>
        </div>

        <!-- School Directors -->
        <div class="tab-content" id="tab-directors">
            <div class="page-title">
                <h2>School Directors</h2>
                <p>School Leadership</p>
            </div>
            <div class="chart-container" id="chart-directors"></div>
        </div>

    </div>

    <script>
        let orgData = [];
        let chartsLoaded = false;

        // Load Google Charts
        google.charts.load('current', {packages: ['orgchart']});
        google.charts.setOnLoadCallback(() => {
            chartsLoaded = true;
            if (orgData.length > 0) {
                renderAllCharts();
            }
        });

        // Load org data from API
        async function loadOrgData() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('tabContent').classList.add('hidden');

            try {
                const response = await fetch('/api/orgchart');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                orgData = await response.json();
                if (chartsLoaded) {
                    renderAllCharts();
                }
            } catch (error) {
                console.error('Error loading org data:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Find a person by name
        function findPerson(searchName) {
            const search = searchName.toLowerCase();
            return orgData.find(p =>
                p.name_key.toLowerCase().includes(search) ||
                p.full_name.toLowerCase().includes(search) ||
                p.last_name.toLowerCase() === search
            );
        }

        // Get direct reports
        function getDirectReports(nameKey) {
            return orgData.filter(p => p.reports_to === nameKey);
        }

        // Build data table for a team starting from a leader
        function buildTeamData(leader, maxDepth = 3) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'Tooltip');

            const visited = new Set();

            function addPerson(person, depth = 0) {
                if (!person || visited.has(person.name_key) || depth > maxDepth) return;
                visited.add(person.name_key);

                const nodeContent = `<div style="padding:4px;"><b>${person.full_name}</b><br><span style="font-size:11px;color:#666;">${person.job_title}</span></div>`;
                const parent = depth === 0 ? '' : person.reports_to;
                data.addRow([{v: person.name_key, f: nodeContent}, parent, person.job_title]);

                const reports = getDirectReports(person.name_key);
                reports.forEach(report => addPerson(report, depth + 1));
            }

            addPerson(leader, 0);
            return data;
        }

        // Build C-Team data (CEO + Chiefs only, plus Kirsten Feil separately)
        function buildCTeamData() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'Tooltip');

            const sabrina = findPerson('Pence');
            if (!sabrina) return data;

            const nodeContent = `<div style="padding:4px;"><b>${sabrina.full_name}</b><br><span style="font-size:11px;color:#666;">${sabrina.job_title}</span></div>`;
            data.addRow([{v: sabrina.name_key, f: nodeContent}, '', sabrina.job_title]);

            // Add direct reports (Chiefs)
            const chiefs = getDirectReports(sabrina.name_key);
            chiefs.forEach(chief => {
                const chiefContent = `<div style="padding:4px;"><b>${chief.full_name}</b><br><span style="font-size:11px;color:#666;">${chief.job_title}</span></div>`;
                data.addRow([{v: chief.name_key, f: chiefContent}, sabrina.name_key, chief.job_title]);
            });

            // Add Kirsten Feil at Chiefs level (reports to Sabrina for positioning)
            const kirsten = findPerson('Feil');
            if (kirsten) {
                const kirstenContent = `<div style="padding:4px;"><b>${kirsten.full_name}</b><br><span style="font-size:11px;color:#666;">${kirsten.job_title}</span></div>`;
                data.addRow([{v: kirsten.name_key, f: kirstenContent}, sabrina.name_key, kirsten.job_title]);
            }

            return data;
        }

        // Build School Directors data (Lashanda + Directors only)
        function buildDirectorsData() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'Tooltip');

            const lashanda = findPerson('Gentry');
            if (!lashanda) return data;

            const nodeContent = `<div style="padding:4px;"><b>${lashanda.full_name}</b><br><span style="font-size:11px;color:#666;">${lashanda.job_title}</span></div>`;
            data.addRow([{v: lashanda.name_key, f: nodeContent}, '', lashanda.job_title]);

            // Add school directors only
            const reports = getDirectReports(lashanda.name_key);
            reports.filter(p => p.job_title.includes('School Director')).forEach(director => {
                const dirContent = `<div style="padding:4px;"><b>${director.full_name}</b><br><span style="font-size:11px;color:#666;">${director.job_title}</span></div>`;
                data.addRow([{v: director.name_key, f: dirContent}, lashanda.name_key, director.job_title]);
            });

            return data;
        }

        // Build Schools Team data (Lashanda + Sivi side by side, excluding School Directors)
        function buildSchoolsTeamData() {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'Tooltip');

            const lashanda = findPerson('Gentry');
            const sivi = findPerson('Domango');
            const visited = new Set();

            function addPersonWithReports(person, parent, maxDepth, depth = 0) {
                if (!person || visited.has(person.name_key) || depth > maxDepth) return;
                // Skip School Directors (they have their own tab)
                if (person.job_title.includes('School Director')) return;
                visited.add(person.name_key);

                const nodeContent = `<div style="padding:4px;"><b>${person.full_name}</b><br><span style="font-size:11px;color:#666;">${person.job_title}</span></div>`;
                data.addRow([{v: person.name_key, f: nodeContent}, parent, person.job_title]);

                const reports = getDirectReports(person.name_key);
                reports.forEach(report => addPersonWithReports(report, person.name_key, maxDepth, depth + 1));
            }

            // Add Lashanda and her reports (excluding School Directors)
            if (lashanda) {
                addPersonWithReports(lashanda, '', 3, 0);
            }

            // Add Sivi and her reports (separate tree)
            if (sivi) {
                addPersonWithReports(sivi, '', 3, 0);
            }

            return data;
        }

        // Render a chart
        function renderChart(containerId, data, allowCollapse = true) {
            const container = document.getElementById(containerId);
            if (!container || data.getNumberOfRows() === 0) return;

            const chart = new google.visualization.OrgChart(container);
            chart.draw(data, {
                allowHtml: true,
                allowCollapse: allowCollapse,
                nodeClass: 'google-visualization-orgchart-node',
                selectedNodeClass: 'google-visualization-orgchart-node-selected',
                size: 'medium'
            });
        }

        // Render all charts
        function renderAllCharts() {
            // C-Team (CEO + Chiefs only)
            renderChart('chart-c-team', buildCTeamData(), false);

            // Operations Team
            const rebekah = findPerson('Straub');
            if (rebekah) {
                renderChart('chart-operations', buildTeamData(rebekah, 3));
            }

            // Dev/Comm Team
            const donna = findPerson('Cavato');
            if (donna) {
                renderChart('chart-devcomm', buildTeamData(donna, 3));
            }

            // HR/Talent Team (Brittney + Scott)
            const brittney = findPerson('Richardson');
            const scott = findPerson('Shirey');

            // Build combined HR/Talent data
            const hrData = new google.visualization.DataTable();
            hrData.addColumn('string', 'Name');
            hrData.addColumn('string', 'Manager');
            hrData.addColumn('string', 'Tooltip');

            const visited = new Set();
            function addPersonHR(person, parent, maxDepth, depth = 0) {
                if (!person || visited.has(person.name_key) || depth > maxDepth) return;
                visited.add(person.name_key);
                const nodeContent = `<div style="padding:4px;"><b>${person.full_name}</b><br><span style="font-size:11px;color:#666;">${person.job_title}</span></div>`;
                hrData.addRow([{v: person.name_key, f: nodeContent}, parent, person.job_title]);
                const reports = getDirectReports(person.name_key);
                reports.forEach(report => addPersonHR(report, person.name_key, maxDepth, depth + 1));
            }
            if (brittney) addPersonHR(brittney, '', 3, 0);
            if (scott) addPersonHR(scott, '', 3, 0);
            renderChart('chart-hr-talent', hrData);

            // Schools Team (Lashanda + Sivi)
            renderChart('chart-schools', buildSchoolsTeamData());

            // School Directors (flat)
            renderChart('chart-directors', buildDirectorsData(), false);

            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('tabContent').classList.remove('hidden');
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const tabId = btn.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`tab-${tabId}`).classList.add('active');
            });
        });

        // Initialize
        loadOrgData();
    </script>
</body>
</html>
