<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schools Team Dashboard | FirstLine Schools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        'fls-orange': '#e47727',
                        'fls-orange-dark': '#c9621c',
                        'fls-navy': '#002f60',
                        'fls-blue': '#094aad',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Open Sans', system-ui, -apple-system, sans-serif;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #e47727;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive table */
        @media (max-width: 1024px) {
            .desktop-table {
                display: none;
            }
            .mobile-cards {
                display: block;
            }
        }

        @media (min-width: 1025px) {
            .desktop-table {
                display: table;
            }
            .mobile-cards {
                display: none;
            }
        }

        /* Progress bar styling */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e2e8f0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Table row hover */
        .table-row {
            transition: all 0.15s ease;
        }

        .table-row:hover {
            background-color: #f1f5f9;
            cursor: pointer;
        }

        .table-row:hover td:first-child {
            border-left: 3px solid #e47727;
            padding-left: calc(1.5rem - 3px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Segmented control */
        .segmented-control {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 0.75rem;
            padding: 4px;
        }

        .segment-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .segment-btn:hover {
            color: #334155;
        }

        .segment-btn.active {
            background-color: #e47727;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(228, 119, 39, 0.3), 0 1px 2px -1px rgba(228, 119, 39, 0.2);
        }

        /* Avatar gradient */
        .avatar-gradient {
            background: linear-gradient(135deg, #094aad 0%, #002f60 100%);
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* Badge styles for subject/grade */
        .badge-subject {
            background-color: #eff6ff;
            color: #1d4ed8;
            font-size: 0.625rem;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .badge-grade {
            background-color: #f0fdf4;
            color: #15803d;
            font-size: 0.625rem;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Login/Selection Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 p-8">
                <!-- Branded Header -->
                <div class="flex items-center justify-center mb-6">
                    <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png" alt="FirstLine Schools" class="h-16">
                </div>

                <h1 class="text-2xl font-semibold text-fls-navy text-center mb-2">Schools Team Dashboard</h1>
                <p class="text-slate-500 text-center mb-8">For network staff who support schools</p>

                <!-- Error Messages -->
                <div id="authError" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-red-800" id="authErrorTitle">Authentication Error</p>
                            <p class="text-sm text-red-700 mt-1" id="authErrorMessage"></p>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="authLoading" class="hidden mb-6 text-center">
                    <div class="loading mx-auto mb-3"></div>
                    <p class="text-sm text-slate-500">Checking authentication...</p>
                </div>

                <!-- Sign In Button -->
                <a href="/login?next=/schools-dashboard" id="googleSignInBtn" class="flex items-center justify-center gap-3 w-full bg-white hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-full border border-slate-300 transition-all shadow-sm hover:shadow">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </a>

                <p id="signInNote" class="text-xs text-slate-400 text-center mt-4">
                    Only @firstlineschools.org accounts are allowed
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="hidden">
        <!-- Sticky Header -->
        <header class="sticky top-0 z-50 bg-fls-navy border-b border-fls-navy">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://firstlineschools.org/wp-content/uploads/2020/08/FLS-Logo_v2019_Color.png" alt="FirstLine Schools" class="h-10 bg-white rounded px-2 py-1">
                        <div>
                            <h1 class="text-lg font-semibold text-white">Schools Team Dashboard</h1>
                            <p class="text-xs text-orange-200" id="roleLabel">Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- User Profile -->
                        <div class="flex items-center gap-2">
                            <img id="userProfilePic" src="" alt="" class="w-8 h-8 rounded-full hidden">
                            <span id="userDisplayName" class="text-sm text-white hidden"></span>
                        </div>
                        <!-- Link to Supervisor Dashboard -->
                        <a href="/" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Supervisor View
                        </a>
                        <!-- Link to HR Dashboard (shown for admins) -->
                        <a href="/hr-dashboard" id="hrDashboardLink" class="hidden inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            HR View
                        </a>
                        <button id="refreshBtn" onclick="loadStaffData()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <a href="/logout" id="logoutBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white hover:bg-fls-blue rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Sign Out
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Filter Bar -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 mb-6">
                <div class="flex flex-wrap items-end gap-4">
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Location</label>
                        <select id="locationFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Supervisor</label>
                        <select id="supervisorFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Supervisors</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Employee Type</label>
                        <select id="employeeTypeFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Job Function</label>
                        <select id="jobFunctionFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Functions</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Subject</label>
                        <select id="subjectFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Grade Band</label>
                        <select id="gradeBandFilter" onchange="applyFilters()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-fls-orange">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="clearFilters()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors">
                            Clear Filters
                        </button>
                        <span id="staffCountDisplay" class="text-sm text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">0 employees</span>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="summaryStats" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-fls-navy/10 flex items-center justify-center">
                            <svg class="w-5 h-5 text-fls-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total Staff</p>
                            <p class="text-2xl font-semibold text-fls-navy" id="statTotalStaff">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Action Needed</p>
                            <p class="text-2xl font-semibold text-red-500" id="statActionNeeded">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Reminders</p>
                            <p class="text-2xl font-semibold text-amber-500" id="statWarnings">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Good Standing</p>
                            <p class="text-2xl font-semibold text-emerald-500" id="statGoodStanding">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="w-full md:w-56 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" id="searchInput" placeholder="Search staff..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fls-orange focus:border-transparent transition-all">
                    </div>
                    <div class="segmented-control">
                        <button class="segment-btn active" data-filter="all">All Staff</button>
                        <button class="segment-btn" data-filter="alerts">With Alerts</button>
                        <button class="segment-btn" data-filter="action">Action Needed</button>
                    </div>
                    <a href="https://sites.google.com/firstlineschools.org/data-portal/home" target="_blank" class="inline-flex items-center gap-2 px-4 py-2.5 bg-fls-orange text-white font-medium rounded-xl hover:bg-orange-600 transition-colors whitespace-nowrap">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Data Portal
                    </a>
                </div>
            </div>

            <!-- Staff List -->
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <div id="loadingIndicator" class="p-12 text-center">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-slate-500 text-sm">Loading staff data...</p>
                </div>

                <div id="staffTableContainer" class="hidden overflow-x-auto">
                    <table class="desktop-table min-w-full">
                        <thead>
                            <tr class="border-b border-slate-200 bg-slate-50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Staff Member</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Location</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Start / Years</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Time Off</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap min-w-[70px]">Total Obs</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap">Last Obs</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wide whitespace-nowrap min-w-[90px]">Action Steps</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody" class="divide-y divide-slate-100">
                        </tbody>
                    </table>

                    <!-- Mobile Cards View -->
                    <div class="mobile-cards p-4 space-y-3" id="staffCardsContainer">
                    </div>
                </div>

                <div id="noDataMessage" class="hidden p-12 text-center">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                    </div>
                    <p class="text-slate-500 text-sm">No staff members found matching your criteria.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail View Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" id="modalBackdrop"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden animate-slide-up">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold text-lg" id="detailAvatar"></div>
                        <div>
                            <h2 class="text-xl font-semibold text-slate-900" id="detailName"></h2>
                            <p class="text-sm text-slate-500" id="detailJobTitleHeader"></p>
                        </div>
                    </div>
                    <button id="closeModalBtn" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Alert Banner -->
                    <div id="detailAlertBanner" class="hidden mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-red-800">Action Required</h3>
                                <div id="detailAlertList" class="text-sm text-red-700 mt-1 space-y-1"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Personal Information -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Personal Information</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Email</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailEmail"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Birthday</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailBirthday"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Hire Date</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailHireDate"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Years of Service</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailYearsOfService"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Job Function</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailJobFunction"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Subject</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailSubject"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Grade Band</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailGradeBand"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Location</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailLocation"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Time Off Balances -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Time Off Balances</h3>
                            <div class="space-y-4">
                                <div id="detailPTORow">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">PTO Hours</span>
                                        <span class="font-medium text-slate-900" id="detailPTOHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-fls-orange" id="detailPTOBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="detailVacationRow">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Vacation Hours</span>
                                        <span class="font-medium text-slate-900" id="detailVacationHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-emerald-500" id="detailVacationBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="detailPersonalRow">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Personal Hours</span>
                                        <span class="font-medium text-slate-900" id="detailPersonalHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-violet-500" id="detailPersonalBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="detailSickRow">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Sick Hours</span>
                                        <span class="font-medium text-slate-900" id="detailSickHours"></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill bg-amber-500" id="detailSickBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observations -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Observations</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Total Observations</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailTotalObs"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Last Observation</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailLastObsType"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Last Observation Date</p>
                                    <p class="text-sm font-medium text-slate-900" id="detailLastObsDate"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Certification -->
                        <div id="detailCertSection" class="bg-slate-50 rounded-xl p-4 hidden">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">Certification</h3>
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">Certified</span>
                                <button id="detailCertViewBtn" class="text-sm text-fls-orange hover:text-fls-orange-dark font-medium">View Details</button>
                            </div>
                        </div>

                        <!-- All Alerts Section -->
                        <div id="detailAlertsSection" class="bg-slate-50 rounded-xl p-4 hidden">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-4">All Alerts & Notes</h3>
                            <div id="detailAlerts" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-slate-200 px-6 py-4">
                    <button id="closeModalBtnFooter" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Certification Detail Modal -->
    <div id="certModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" id="certModalBackdrop"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden animate-slide-up">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-fls-orange text-white text-lg font-bold flex items-center justify-center">C</div>
                        <div>
                            <h2 class="text-lg font-semibold text-slate-900">Certifications</h2>
                            <p class="text-sm text-slate-500" id="certEmployeeName"></p>
                        </div>
                    </div>
                    <button id="closeCertModalBtn" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Loading State -->
                    <div id="certLoading" class="p-12 text-center">
                        <div class="loading mx-auto mb-4"></div>
                        <p class="text-slate-500 text-sm">Loading certification data...</p>
                    </div>

                    <!-- No Data State -->
                    <div id="certNoData" class="hidden p-12 text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <p class="text-slate-500 text-sm">No certification data found for this employee.</p>
                    </div>

                    <!-- Certification Content -->
                    <div id="certContent" class="hidden p-6 space-y-4">
                        <!-- Summary Banner -->
                        <div id="certSummaryBanner" class="p-4 rounded-xl bg-emerald-50 border border-emerald-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-emerald-800" id="certSummaryStatus"></p>
                                    <p class="text-xs text-emerald-600" id="certSummaryCount"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Info -->
                        <div class="bg-slate-50 rounded-xl p-4">
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <p class="text-xs text-slate-500">Title</p>
                                    <p class="font-medium text-slate-900" id="certStaffTitle"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">School</p>
                                    <p class="font-medium text-slate-900" id="certStaffSchool"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Active Certifications List -->
                        <div>
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Active Certifications</h3>
                            <div id="certActiveList" class="space-y-2"></div>
                        </div>

                        <!-- Expired Certifications (if any) -->
                        <div id="certExpiredSection" class="hidden">
                            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Expired Certifications</h3>
                            <div id="certExpiredList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-slate-200 px-6 py-4">
                    <button id="closeCertModalBtnFooter" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Step Modal -->
    <div id="actionStepModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" onclick="closeActionStepModal()"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
                <!-- Modal Header -->
                <div class="bg-fls-navy text-white px-6 py-4 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="actionStepModalTitle">Action Steps</h2>
                            <p class="text-sm text-white/70" id="actionStepModalSubtitle"></p>
                        </div>
                    </div>
                    <button onclick="closeActionStepModal()" class="w-8 h-8 rounded-lg hover:bg-white/20 flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="bg-slate-50 px-6 py-3 flex gap-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-fls-blue"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepInProgressCount">0</span> In Progress</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepMasteredCount">0</span> Mastered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="text-xs text-slate-600"><span id="actionStepNotMasteredCount">0</span> Not Mastered</span>
                    </div>
                </div>

                <!-- Modal Body - Scrollable List -->
                <div class="p-4 space-y-3 overflow-y-auto flex-1" id="actionStepsList">
                </div>

                <!-- Modal Footer -->
                <div class="bg-white border-t border-slate-200 px-6 py-4 flex-shrink-0">
                    <button onclick="closeActionStepModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Observations Detail Modal -->
    <div id="observationsModal" class="fixed inset-0 z-50 hidden animate-fade-in">
        <div class="modal-backdrop absolute inset-0" onclick="closeObservationsModal()"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
                <!-- Modal Header -->
                <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="observationsModalTitle">Observations</h2>
                            <p class="text-sm text-white/70" id="observationsModalSubtitle"></p>
                        </div>
                    </div>
                    <button onclick="closeObservationsModal()" class="w-8 h-8 rounded-lg hover:bg-white/20 flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body - Scrollable List -->
                <div class="p-4 space-y-3 overflow-y-auto flex-1" id="observationsList">
                </div>

                <!-- Modal Footer -->
                <div class="bg-white border-t border-slate-200 px-6 py-4 flex-shrink-0">
                    <button onclick="closeObservationsModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2.5 px-4 rounded-xl transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let staffData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let currentDetailEmail = '';
        let certificationStatus = {};
        let actionStepsData = {};
        let schoolsRole = null;

        // API base URL
        const API_BASE = window.location.origin;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            setupEventListeners();
            handleUrlErrors();
        });

        // Check URL for error parameters
        function handleUrlErrors() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const domain = urlParams.get('domain');

            if (error) {
                const errorDiv = document.getElementById('authError');
                const errorTitle = document.getElementById('authErrorTitle');
                const errorMessage = document.getElementById('authErrorMessage');

                if (error === 'unauthorized_domain') {
                    errorTitle.textContent = 'Unauthorized Domain';
                    errorMessage.textContent = `Only @firstlineschools.org accounts are allowed. You signed in with an @${domain || 'unknown'} account.`;
                } else if (error === 'auth_failed') {
                    errorTitle.textContent = 'Authentication Failed';
                    errorMessage.textContent = 'There was a problem signing you in. Please try again.';
                } else if (error === 'session_expired') {
                    errorTitle.textContent = 'Session Expired';
                    errorMessage.textContent = 'Your session has expired. Please sign in again.';
                } else if (error === 'access_denied') {
                    errorTitle.textContent = 'Access Denied';
                    errorMessage.textContent = 'You do not have permission to access the Schools Team Dashboard. This dashboard is available to specific network roles.';
                } else {
                    errorTitle.textContent = 'Error';
                    errorMessage.textContent = 'An unexpected error occurred. Please try again.';
                }

                errorDiv.classList.remove('hidden');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Check authentication status
        async function checkAuthStatus() {
            const authLoading = document.getElementById('authLoading');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const signInNote = document.getElementById('signInNote');

            try {
                authLoading.classList.remove('hidden');
                googleSignInBtn.classList.add('hidden');
                signInNote.classList.add('hidden');

                const response = await fetch(`${API_BASE}/api/auth/status`, {
                    credentials: 'include'
                });
                const data = await response.json();

                authLoading.classList.add('hidden');

                if (data.authenticated && data.user) {
                    currentUser = data.user;

                    // Check schools dashboard access
                    if (!data.schools_dashboard_access) {
                        window.location.href = '/schools-dashboard?error=access_denied';
                        return;
                    }

                    schoolsRole = data.schools_dashboard_role;

                    // Update user profile in header
                    if (data.user.picture) {
                        const profilePic = document.getElementById('userProfilePic');
                        profilePic.src = data.user.picture;
                        profilePic.classList.remove('hidden');
                    }
                    if (data.user.name) {
                        const displayName = document.getElementById('userDisplayName');
                        displayName.textContent = data.user.name;
                        displayName.classList.remove('hidden');
                    }

                    // Update role label
                    document.getElementById('roleLabel').textContent = schoolsRole ? schoolsRole.label : 'Schools Support';

                    // Show HR Dashboard link for admins
                    if (data.is_admin) {
                        document.getElementById('hrDashboardLink').classList.remove('hidden');
                    }

                    // Show dashboard
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboardScreen').classList.remove('hidden');

                    // Load filter options then load data
                    await loadFilterOptions();
                    loadStaffData();
                } else {
                    googleSignInBtn.classList.remove('hidden');
                    signInNote.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                authLoading.classList.add('hidden');
                googleSignInBtn.classList.remove('hidden');
                signInNote.classList.remove('hidden');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('searchInput').addEventListener('input', filterData);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('closeModalBtnFooter').addEventListener('click', closeModal);
            document.getElementById('modalBackdrop').addEventListener('click', closeModal);

            // Filter buttons (segmented control)
            document.querySelectorAll('.segment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentFilter = e.target.dataset.filter;
                    updateFilterButtons();
                    filterData();
                });
            });

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeCertModal();
                    closeActionStepModal();
                    closeObservationsModal();
                }
            });

            // Certification Modal event listeners
            document.getElementById('closeCertModalBtn').addEventListener('click', closeCertModal);
            document.getElementById('closeCertModalBtnFooter').addEventListener('click', closeCertModal);
            document.getElementById('certModalBackdrop').addEventListener('click', closeCertModal);
        }

        // Load staff data from API
        async function loadStaffData() {
            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('staffTableContainer').classList.add('hidden');
                document.getElementById('noDataMessage').classList.add('hidden');

                // Build filter query string
                const params = new URLSearchParams();
                const locationFilter = document.getElementById('locationFilter')?.value || '';
                const supervisorFilter = document.getElementById('supervisorFilter')?.value || '';
                const employeeTypeFilter = document.getElementById('employeeTypeFilter')?.value || '';
                const jobFunctionFilter = document.getElementById('jobFunctionFilter')?.value || '';
                const subjectFilter = document.getElementById('subjectFilter')?.value || '';
                const gradeBandFilter = document.getElementById('gradeBandFilter')?.value || '';

                if (locationFilter) params.append('location', locationFilter);
                if (supervisorFilter) params.append('supervisor', supervisorFilter);
                if (employeeTypeFilter) params.append('employee_type', employeeTypeFilter);
                if (jobFunctionFilter) params.append('job_function', jobFunctionFilter);
                if (subjectFilter) params.append('subject', subjectFilter);
                if (gradeBandFilter) params.append('grade_band', gradeBandFilter);

                const queryString = params.toString() ? `?${params.toString()}` : '';

                // Load staff data, certification status, and action steps in parallel
                const [staffResponse, certResponse, actionStepsResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/schools/staff${queryString}`, {
                        credentials: 'include'
                    }),
                    fetch(`${API_BASE}/api/cert-status`, {
                        credentials: 'include'
                    }),
                    fetch(`${API_BASE}/api/schools/action-steps`, {
                        credentials: 'include'
                    })
                ]);

                // Handle authentication errors
                if (staffResponse.status === 401) {
                    window.location.href = '/schools-dashboard?error=session_expired';
                    return;
                }

                if (staffResponse.status === 403) {
                    window.location.href = '/schools-dashboard?error=access_denied';
                    return;
                }

                if (!staffResponse.ok) throw new Error('Failed to fetch staff data');

                staffData = await staffResponse.json();
                filteredData = [...staffData];

                // Load certification status (non-blocking if fails)
                if (certResponse.ok) {
                    certificationStatus = await certResponse.json();
                } else {
                    certificationStatus = {};
                }

                // Load action steps (non-blocking if fails)
                if (actionStepsResponse.ok) {
                    actionStepsData = await actionStepsResponse.json();
                } else {
                    actionStepsData = {};
                }

                document.getElementById('loadingIndicator').classList.add('hidden');

                if (staffData.length === 0) {
                    document.getElementById('noDataMessage').classList.remove('hidden');
                } else {
                    document.getElementById('staffTableContainer').classList.remove('hidden');
                    updateSummaryStats(staffData);
                    renderListView(filteredData);
                }

                // Update staff count display
                document.getElementById('staffCountDisplay').textContent = `${staffData.length} employees`;
            } catch (error) {
                console.error('Error loading staff data:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
                alert('Failed to load staff data. Please try again.');
            }
        }

        // Load filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch(`${API_BASE}/api/schools/filter-options`, {
                    credentials: 'include'
                });
                if (!response.ok) return;

                const options = await response.json();

                // Populate location filter
                const locationSelect = document.getElementById('locationFilter');
                options.locations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = loc;
                    locationSelect.appendChild(opt);
                });

                // Populate supervisor filter
                const supervisorSelect = document.getElementById('supervisorFilter');
                options.supervisors.forEach(sup => {
                    const opt = document.createElement('option');
                    opt.value = sup;
                    opt.textContent = sup;
                    supervisorSelect.appendChild(opt);
                });

                // Populate employee type filter
                const employeeTypeSelect = document.getElementById('employeeTypeFilter');
                options.employee_types.forEach(type => {
                    const opt = document.createElement('option');
                    opt.value = type;
                    opt.textContent = type;
                    employeeTypeSelect.appendChild(opt);
                });

                // Populate job function filter
                const jobFunctionSelect = document.getElementById('jobFunctionFilter');
                options.job_functions.forEach(func => {
                    const opt = document.createElement('option');
                    opt.value = func;
                    opt.textContent = func;
                    jobFunctionSelect.appendChild(opt);
                });

                // Populate subject filter
                const subjectSelect = document.getElementById('subjectFilter');
                options.subjects.forEach(subj => {
                    const opt = document.createElement('option');
                    opt.value = subj;
                    opt.textContent = subj;
                    subjectSelect.appendChild(opt);
                });

                // Populate grade band filter
                const gradeBandSelect = document.getElementById('gradeBandFilter');
                options.grade_bands.forEach(band => {
                    const opt = document.createElement('option');
                    opt.value = band;
                    opt.textContent = band;
                    gradeBandSelect.appendChild(opt);
                });
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Apply filters
        function applyFilters() {
            loadStaffData();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('locationFilter').value = '';
            document.getElementById('supervisorFilter').value = '';
            document.getElementById('employeeTypeFilter').value = '';
            document.getElementById('jobFunctionFilter').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('gradeBandFilter').value = '';
            loadStaffData();
        }

        // Calculate and update summary stats
        function updateSummaryStats(data) {
            let actionNeeded = 0;
            let warnings = 0;
            let goodStanding = 0;

            data.forEach(staff => {
                const alerts = calculateAlerts(staff);
                if (alerts.level === 'red') actionNeeded++;
                else if (alerts.level === 'yellow') warnings++;
                else goodStanding++;
            });

            document.getElementById('statTotalStaff').textContent = data.length;
            document.getElementById('statActionNeeded').textContent = actionNeeded;
            document.getElementById('statWarnings').textContent = warnings;
            document.getElementById('statGoodStanding').textContent = goodStanding;
        }

        // Refresh data
        function refreshData() {
            loadStaffData();
        }

        // Filter data based on search and filter type
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = staffData.filter(staff => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (staff.Staff_Name || '').toLowerCase().includes(searchTerm) ||
                    (staff.Location_Name || '').toLowerCase().includes(searchTerm);

                // Alert filter
                const alerts = calculateAlerts(staff);
                let matchesFilter = true;

                if (currentFilter === 'alerts') {
                    matchesFilter = alerts.level === 'red' || alerts.level === 'yellow';
                } else if (currentFilter === 'action') {
                    matchesFilter = alerts.level === 'red';
                }

                return matchesSearch && matchesFilter;
            });

            renderListView(filteredData);
        }

        // Update filter button styles (segmented control)
        function updateFilterButtons() {
            document.querySelectorAll('.segment-btn').forEach(btn => {
                if (btn.dataset.filter === currentFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Get avatar initials
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ').filter(p => p.length > 0);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return parts[0] ? parts[0][0].toUpperCase() : '?';
        }

        // Get time off data (available hours and max hours) from accrual fields
        function getTimeOffData(staff) {
            let available = 0;
            let max = 0;

            const ptoMax = parseFloat(staff.pto_max) || 0;
            const ptoAvailable = parseFloat(staff.pto_available);
            const vacationMax = parseFloat(staff.vacation_max) || 0;
            const vacationAvailable = parseFloat(staff.vacation_available);

            if (ptoMax > 0) {
                available = isNaN(ptoAvailable) ? 0 : ptoAvailable;
                max = ptoMax;
            }
            else if (vacationMax > 0) {
                available = isNaN(vacationAvailable) ? 0 : vacationAvailable;
                max = vacationMax;
            }

            return { available, max };
        }

        // Get certification badge HTML for a staff member
        function getCertBadge(email) {
            if (!email) return '';
            const certInfo = certificationStatus[email.toLowerCase()];
            if (!certInfo || certInfo.status !== 'Certified') return '';

            return `<button onclick="event.stopPropagation(); showCertDetail('${email}')"
                class="ml-2 w-5 h-5 rounded bg-fls-orange text-white text-xs font-bold flex items-center justify-center hover:bg-fls-orange-dark transition-colors"
                title="Certified - Click to view certifications">C</button>`;
        }

        // Get subject/grade badges HTML
        function getSubjectGradeBadges(staff) {
            let badges = '';
            if (staff.Subject_Desc) {
                badges += `<span class="badge-subject">${staff.Subject_Desc}</span> `;
            }
            if (staff.grade_band) {
                badges += `<span class="badge-grade">${staff.grade_band}</span>`;
            }
            return badges;
        }

        // Render list view
        function renderListView(data) {
            const tableBody = document.getElementById('staffTableBody');
            const cardsContainer = document.getElementById('staffCardsContainer');

            tableBody.innerHTML = '';
            cardsContainer.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('staffTableContainer').classList.add('hidden');
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('staffTableContainer').classList.remove('hidden');
            document.getElementById('noDataMessage').classList.add('hidden');

            data.forEach(staff => {
                const alerts = calculateAlerts(staff);
                const yearsOfService = staff.years_of_service ? `${staff.years_of_service}` : '0';
                const initials = getInitials(staff.Staff_Name);

                // Calculate time off
                const timeOffData = getTimeOffData(staff);
                const timeOffHours = timeOffData.available;
                const timeOffMax = timeOffData.max;
                const timeOffProgress = timeOffMax > 0 ? Math.min(100, Math.max(0, (timeOffHours / timeOffMax) * 100)) : 0;
                const timeOffPercent = timeOffMax > 0 ? (timeOffHours / timeOffMax) : 0;
                const isNegative = timeOffHours < 0;
                const timeOffColor = isNegative ? 'bg-red-600' : timeOffPercent < 0.25 ? 'bg-red-500' : timeOffPercent < 0.5 ? 'bg-amber-500' : 'bg-emerald-500';
                const timeOffTextColor = isNegative ? 'text-red-600 font-semibold' : 'text-slate-600';

                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.onclick = () => renderDetailView(staff);

                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">${initials}</div>
                            <div>
                                <div class="flex items-center font-medium text-slate-900 whitespace-nowrap">${staff.Staff_Name || 'N/A'}${getCertBadge(staff.Email_Address)}</div>
                                <div class="text-xs text-slate-500 whitespace-nowrap">${staff.job_title || 'N/A'}</div>
                                <div class="flex gap-1 mt-1">${getSubjectGradeBadges(staff)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-700">${staff.Location_Name || 'N/A'}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-slate-600">${formatDate(staff.Last_Hire_Date)}</div>
                        <div class="text-xs text-slate-400">${yearsOfService} yr${staff.years_of_service === 1 ? '' : 's'}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="w-24">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="${timeOffTextColor}">${timeOffHours.toFixed(0)}h / ${timeOffMax.toFixed(0)}h</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${timeOffColor}" style="width: ${timeOffProgress}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center min-w-[70px]">
                        ${getTotalObsCell(staff.Email_Address, staff.total_observations)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${staff.last_observation_date ? `
                            <div class="text-xs">
                                <span class="font-medium text-slate-700">${formatShortDate(staff.last_observation_date)}</span>
                                <div class="text-slate-400">${staff.last_observation_type || ''}</div>
                            </div>
                        ` : '<span class="text-xs text-slate-400">&mdash;</span>'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap min-w-[90px]">
                        ${getActionStepCell(staff.Email_Address)}
                    </td>
                `;
                tableBody.appendChild(row);

                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-white border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-slate-300 transition-colors';
                card.onclick = () => renderDetailView(staff);
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-full avatar-gradient flex items-center justify-center text-white font-semibold">${initials}</div>
                            <div>
                                <div class="flex items-center font-semibold text-slate-900">${staff.Staff_Name || 'N/A'}${getCertBadge(staff.Email_Address)}</div>
                                <div class="text-sm text-slate-500">${staff.job_title || 'N/A'}</div>
                                <div class="flex gap-1 mt-1">${getSubjectGradeBadges(staff)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                        <div>
                            <div class="text-sm font-medium text-slate-700">${staff.Location_Name || 'N/A'}</div>
                            <div class="text-xs text-slate-500">Location</div>
                        </div>
                        <div>
                            <div class="text-lg font-semibold text-slate-900">${staff.total_observations || 0}</div>
                            <div class="text-xs text-slate-500">Total Obs</div>
                        </div>
                        <div>
                            <div class="text-sm font-semibold text-slate-900">${yearsOfService} yr${staff.years_of_service === 1 ? '' : 's'}</div>
                            <div class="text-xs text-slate-500">Service</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <div class="text-xs text-slate-500">${staff.Supervisor_Name__Unsecured_ || ''}</div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
        }

        // Get employee status badge HTML - smaller version for inline display
        function getEmployeeStatusBadgeSmall(status) {
            const statusLower = (status || '').toLowerCase();
            let colors, text;

            if (statusLower === 'active' || statusLower === 'employed') {
                colors = 'bg-emerald-50 text-emerald-700';
                text = 'Active';
            } else if (statusLower === 'on leave' || statusLower === 'leave' || statusLower === 'leave of absence') {
                colors = 'bg-amber-50 text-amber-700';
                text = 'On Leave';
            } else if (statusLower === 'terminated' || statusLower === 'inactive') {
                colors = 'bg-red-50 text-red-700';
                text = 'Inactive';
            } else if (statusLower === 'pending') {
                colors = 'bg-slate-100 text-slate-600';
                text = 'Pending';
            } else {
                colors = 'bg-slate-50 text-slate-500';
                text = status || '&mdash;';
            }

            return `<span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium ${colors}">${text}</span>`;
        }

        // Get action step status text and color
        function getActionStepStatus(progress_percent) {
            if (progress_percent === 100) {
                return { text: 'Mastered', bgColor: 'bg-emerald-500', textColor: 'text-emerald-600' };
            } else if (progress_percent === 0) {
                return { text: 'In Progress', bgColor: 'bg-fls-blue', textColor: 'text-fls-blue' };
            } else if (progress_percent === -1 || progress_percent === -10) {
                return { text: 'Not Mastered', bgColor: 'bg-red-500', textColor: 'text-red-600' };
            }
            return { text: 'Unknown', bgColor: 'bg-slate-300', textColor: 'text-slate-600' };
        }

        // Get action step cell HTML
        function getActionStepCell(email) {
            const actionSteps = actionStepsData[email.toLowerCase()];

            if (!actionSteps || actionSteps.length === 0) {
                return `<span class="text-xs text-slate-400">&mdash;</span>`;
            }

            const inProgressCount = actionSteps.filter(s => s.progress_percent === 0).length;
            const totalCount = actionSteps.length;

            return `
                <button onclick="event.stopPropagation(); showActionStepModal('${email}')"
                    class="text-left hover:bg-slate-50 rounded-lg p-1 -m-1 transition-colors">
                    <div class="flex items-center gap-1.5">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-fls-blue text-white text-xs font-bold">${inProgressCount}</span>
                        <span class="text-xs text-slate-500">of ${totalCount}</span>
                    </div>
                </button>
            `;
        }

        // Show action step modal
        function showActionStepModal(email) {
            const actionSteps = actionStepsData[email.toLowerCase()];
            const modal = document.getElementById('actionStepModal');

            if (!actionSteps || actionSteps.length === 0) {
                return;
            }

            const staffName = actionSteps[0].user_name || 'Staff Member';
            document.getElementById('actionStepModalTitle').textContent = staffName;
            document.getElementById('actionStepModalSubtitle').textContent = `${actionSteps.length} Action Step${actionSteps.length !== 1 ? 's' : ''} This Year`;

            const inProgressCount = actionSteps.filter(s => s.progress_percent === 0).length;
            const masteredCount = actionSteps.filter(s => s.progress_percent === 100).length;
            const notMasteredCount = actionSteps.filter(s => s.progress_percent === -1 || s.progress_percent === -10).length;

            document.getElementById('actionStepInProgressCount').textContent = inProgressCount;
            document.getElementById('actionStepMasteredCount').textContent = masteredCount;
            document.getElementById('actionStepNotMasteredCount').textContent = notMasteredCount;

            const listContainer = document.getElementById('actionStepsList');
            listContainer.innerHTML = actionSteps.map(step => {
                const status = getActionStepStatus(step.progress_percent);
                const tagsHtml = step.tags
                    ? step.tags.split(', ').map(tag =>
                        `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-slate-100 text-slate-600">${tag}</span>`
                      ).join('')
                    : '';

                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-slate-300 transition-colors">
                        <div class="flex items-start justify-between gap-3 mb-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status.bgColor} text-white">${status.text}</span>
                            <span class="text-xs text-slate-400">${formatShortDate(step.created)}</span>
                        </div>
                        <p class="text-sm text-slate-800 leading-relaxed mb-2">${step.name || 'No description'}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-wrap gap-1">${tagsHtml}</div>
                            <span class="text-xs text-slate-400">by ${step.creator_name || 'Unknown'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            modal.classList.remove('hidden');
        }

        // Close action step modal
        function closeActionStepModal() {
            document.getElementById('actionStepModal').classList.add('hidden');
        }

        // Get total observations cell HTML
        function getTotalObsCell(email, totalObs) {
            const count = totalObs || 0;

            if (count === 0) {
                return `<span class="text-sm text-slate-400">0</span>`;
            }

            return `
                <button onclick="event.stopPropagation(); showObservationsModal('${email}')"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold text-sm transition-colors">
                    ${count}
                </button>
            `;
        }

        // Show observations modal
        async function showObservationsModal(email) {
            const modal = document.getElementById('observationsModal');
            const listContainer = document.getElementById('observationsList');

            const staffMember = staffData.find(s => s.Email_Address && s.Email_Address.toLowerCase() === email.toLowerCase());
            const staffName = staffMember ? staffMember.Staff_Name : 'Staff Member';

            document.getElementById('observationsModalTitle').textContent = staffName;
            document.getElementById('observationsModalSubtitle').textContent = 'Loading observations...';
            listContainer.innerHTML = '<div class="text-center py-8"><div class="loading mx-auto"></div></div>';

            modal.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/observations/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch observations');
                }

                const observations = await response.json();

                document.getElementById('observationsModalSubtitle').textContent = `${observations.length} Observation${observations.length !== 1 ? 's' : ''} This Year`;

                if (observations.length === 0) {
                    listContainer.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <p>No observations recorded this school year</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                observations.forEach(o => {
                    const typeColor = (o.observation_type || '').includes('Self') ? 'bg-purple-500' :
                                     (o.observation_type || '').includes('PMAP') ? 'bg-emerald-500' : 'bg-blue-500';

                    html += `
                        <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-slate-300 transition-colors">
                            <div class="flex items-start justify-between gap-3 mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeColor} text-white">${o.observation_type || 'Observation'}</span>
                                <span class="text-xs text-slate-400">${formatShortDate(o.observed_at)}</span>
                            </div>
                            <p class="text-sm text-slate-700 mb-1">${o.rubric_form || 'Standard Observation'}</p>
                            <div class="flex items-center justify-between text-xs text-slate-400">
                                <span>${o.school || ''}</span>
                                <span>by ${o.observer_name || 'Unknown'}</span>
                            </div>
                            ${o.link ? `<a href="${o.link}" target="_blank" class="inline-flex items-center gap-1 mt-2 text-xs text-fls-blue hover:underline">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                                View in Grow
                            </a>` : ''}
                        </div>
                    `;
                });

                listContainer.innerHTML = html;

            } catch (error) {
                console.error('Error loading observations:', error);
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>Failed to load observations</p>
                    </div>
                `;
            }
        }

        // Close observations modal
        function closeObservationsModal() {
            document.getElementById('observationsModal').classList.add('hidden');
        }

        // Render detail view modal
        function renderDetailView(staff) {
            currentDetailEmail = staff.Email_Address || '';

            const initials = getInitials(staff.Staff_Name);
            document.getElementById('detailAvatar').textContent = initials;
            document.getElementById('detailName').textContent = staff.Staff_Name || 'N/A';
            document.getElementById('detailJobTitleHeader').textContent = staff.job_title || 'N/A';
            document.getElementById('detailEmail').textContent = staff.Email_Address || 'N/A';

            // Birthday: month/day only (no year - sent as MM-DD from backend)
            document.getElementById('detailBirthday').textContent = formatBirthdayMonthDay(staff.birthday_month_day);

            document.getElementById('detailHireDate').textContent = formatDate(staff.Last_Hire_Date);
            document.getElementById('detailYearsOfService').textContent = staff.years_of_service ? `${staff.years_of_service} years` : 'N/A';
            document.getElementById('detailJobFunction').textContent = staff.Job_Function || 'N/A';
            document.getElementById('detailSubject').textContent = staff.Subject_Desc || 'N/A';
            document.getElementById('detailGradeBand').textContent = staff.grade_band || 'N/A';
            document.getElementById('detailLocation').textContent = staff.Location_Name || 'N/A';

            // Time off with progress bars
            const ptoMax = parseFloat(staff.pto_max) || 0;
            const ptoAvailable = parseFloat(staff.pto_available) || 0;
            const vacationMax = parseFloat(staff.vacation_max) || 0;
            const vacationAvailable = parseFloat(staff.vacation_available) || 0;
            const personalMax = parseFloat(staff.personal_max) || 0;
            const personalAvailable = parseFloat(staff.personal_available) || 0;
            const sickMax = parseFloat(staff.sick_max) || 0;
            const sickAvailable = parseFloat(staff.sick_available) || 0;

            const formatTimeOff = (avail, max) => {
                if (max > 0) return `${avail.toFixed(1)} / ${max.toFixed(0)}h`;
                return '&mdash;';
            };

            const hasPTO = ptoMax > 0;
            const hasVacation = vacationMax > 0;
            const hasPersonal = personalMax > 0;
            const hasSick = sickMax > 0;

            document.getElementById('detailPTORow').style.display = hasPTO ? 'block' : 'none';
            document.getElementById('detailVacationRow').style.display = hasVacation ? 'block' : 'none';
            document.getElementById('detailPersonalRow').style.display = hasPersonal ? 'block' : 'none';
            document.getElementById('detailSickRow').style.display = hasSick ? 'block' : 'none';

            const ptoHoursEl = document.getElementById('detailPTOHours');
            const vacationHoursEl = document.getElementById('detailVacationHours');
            const personalHoursEl = document.getElementById('detailPersonalHours');
            const sickHoursEl = document.getElementById('detailSickHours');

            ptoHoursEl.innerHTML = formatTimeOff(ptoAvailable, ptoMax);
            ptoHoursEl.className = ptoAvailable < 0 ? 'font-medium text-red-600' : 'font-medium text-slate-900';

            vacationHoursEl.innerHTML = formatTimeOff(vacationAvailable, vacationMax);
            vacationHoursEl.className = vacationAvailable < 0 ? 'font-medium text-red-600' : 'font-medium text-slate-900';

            personalHoursEl.innerHTML = formatTimeOff(personalAvailable, personalMax);
            personalHoursEl.className = personalAvailable < 0 ? 'font-medium text-red-600' : 'font-medium text-slate-900';

            sickHoursEl.innerHTML = formatTimeOff(sickAvailable, sickMax);
            sickHoursEl.className = sickAvailable < 0 ? 'font-medium text-red-600' : 'font-medium text-slate-900';

            const getTimeOffColorClass = (avail, max) => {
                if (max <= 0) return 'bg-slate-300';
                if (avail < 0) return 'bg-red-600';
                const percent = avail / max;
                return percent < 0.25 ? 'bg-red-500' : percent < 0.5 ? 'bg-amber-500' : 'bg-emerald-500';
            };

            const ptoBar = document.getElementById('detailPTOBar');
            const vacationBar = document.getElementById('detailVacationBar');
            const personalBar = document.getElementById('detailPersonalBar');
            const sickBar = document.getElementById('detailSickBar');

            ptoBar.style.width = `${ptoMax > 0 ? Math.min(100, (Math.max(0, ptoAvailable) / ptoMax) * 100) : 0}%`;
            ptoBar.className = `progress-bar-fill ${getTimeOffColorClass(ptoAvailable, ptoMax)}`;

            vacationBar.style.width = `${vacationMax > 0 ? Math.min(100, (Math.max(0, vacationAvailable) / vacationMax) * 100) : 0}%`;
            vacationBar.className = `progress-bar-fill ${getTimeOffColorClass(vacationAvailable, vacationMax)}`;

            personalBar.style.width = `${personalMax > 0 ? Math.min(100, (Math.max(0, personalAvailable) / personalMax) * 100) : 0}%`;
            personalBar.className = `progress-bar-fill ${getTimeOffColorClass(personalAvailable, personalMax)}`;

            sickBar.style.width = `${sickMax > 0 ? Math.min(100, (Math.max(0, sickAvailable) / sickMax) * 100) : 0}%`;
            sickBar.className = `progress-bar-fill ${getTimeOffColorClass(sickAvailable, sickMax)}`;

            // Observations
            document.getElementById('detailTotalObs').textContent = staff.total_observations || '0';
            document.getElementById('detailLastObsType').textContent = staff.last_observation_type || 'N/A';
            document.getElementById('detailLastObsDate').textContent = formatDate(staff.last_observation_date);

            // Certification section
            const certSection = document.getElementById('detailCertSection');
            const certInfo = certificationStatus[(staff.Email_Address || '').toLowerCase()];
            if (certInfo && certInfo.status === 'Certified') {
                certSection.classList.remove('hidden');
                document.getElementById('detailCertViewBtn').onclick = () => { closeModal(); showCertDetail(staff.Email_Address); };
            } else {
                certSection.classList.add('hidden');
            }

            // Render alerts
            const alerts = calculateAlerts(staff);
            const alertBanner = document.getElementById('detailAlertBanner');
            const alertList = document.getElementById('detailAlertList');
            const alertsSection = document.getElementById('detailAlertsSection');
            const alertsContainer = document.getElementById('detailAlerts');

            const redAlerts = alerts.items.filter(a => a.level === 'red');
            if (redAlerts.length > 0) {
                alertBanner.classList.remove('hidden');
                alertList.innerHTML = redAlerts.map(a => `<p>&bull; ${a.message}</p>`).join('');
            } else {
                alertBanner.classList.add('hidden');
            }

            alertsContainer.innerHTML = '';
            if (alerts.items.length === 0) {
                alertsSection.classList.add('hidden');
            } else {
                alertsSection.classList.remove('hidden');
                alerts.items.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    const alertColors = {
                        red: 'bg-red-50 border-red-200 text-red-700',
                        yellow: 'bg-amber-50 border-amber-200 text-amber-700',
                        green: 'bg-emerald-50 border-emerald-200 text-emerald-700'
                    };
                    alertDiv.className = `p-3 rounded-lg border text-sm ${alertColors[alert.level]}`;
                    alertDiv.textContent = alert.message;
                    alertsContainer.appendChild(alertDiv);
                });
            }

            document.getElementById('detailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Show Certification Detail Modal
        async function showCertDetail(email) {
            if (!email) return;

            const modal = document.getElementById('certModal');
            const loading = document.getElementById('certLoading');
            const noData = document.getElementById('certNoData');
            const content = document.getElementById('certContent');

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            loading.classList.remove('hidden');
            noData.classList.add('hidden');
            content.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/cert-detail/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });

                loading.classList.add('hidden');

                if (response.status === 404) {
                    noData.classList.remove('hidden');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch certification data');
                }

                const data = await response.json();
                renderCertDetail(data);

            } catch (error) {
                console.error('Error fetching certification detail:', error);
                loading.classList.add('hidden');
                noData.classList.remove('hidden');
            }
        }

        // Render certification detail data
        function renderCertDetail(data) {
            const content = document.getElementById('certContent');
            content.classList.remove('hidden');

            document.getElementById('certEmployeeName').textContent = data.name || '';

            document.getElementById('certSummaryStatus').textContent =
                data.certification_status === 'Certified' ? 'State Certified' : data.certification_status;
            document.getElementById('certSummaryCount').textContent =
                `${data.active_certifications || 0} active certification${data.active_certifications !== 1 ? 's' : ''}`;

            document.getElementById('certStaffTitle').textContent = data.title || 'N/A';
            document.getElementById('certStaffSchool').textContent = data.school || 'N/A';

            const activeList = document.getElementById('certActiveList');
            const activeCerts = (data.certifications || []).filter(c => c.status === 'Active' && c.expiration_status !== 'Expired');

            if (activeCerts.length > 0) {
                activeList.innerHTML = activeCerts.map(cert => `
                    <div class="bg-white border border-slate-200 rounded-xl p-3">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-slate-900 text-sm">${cert.qualification || 'Unknown'}</p>
                                <p class="text-xs text-slate-500">${cert.category || ''}</p>
                            </div>
                            ${getCertExpirationBadge(cert)}
                        </div>
                        <div class="mt-2 flex gap-4 text-xs text-slate-500">
                            <span>Earned: ${formatDateShort(cert.earn_date)}</span>
                            <span>Expires: ${formatDateShort(cert.expire_date)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                activeList.innerHTML = '<p class="text-sm text-slate-500 italic">No active certifications</p>';
            }

            const expiredSection = document.getElementById('certExpiredSection');
            const expiredList = document.getElementById('certExpiredList');
            const expiredCerts = (data.certifications || []).filter(c => c.status !== 'Active' || c.expiration_status === 'Expired');

            if (expiredCerts.length > 0) {
                expiredSection.classList.remove('hidden');
                expiredList.innerHTML = expiredCerts.map(cert => `
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 opacity-75">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-slate-700 text-sm">${cert.qualification || 'Unknown'}</p>
                                <p class="text-xs text-slate-500">${cert.category || ''}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-600">Expired</span>
                        </div>
                        <div class="mt-2 flex gap-4 text-xs text-slate-400">
                            <span>Earned: ${formatDateShort(cert.earn_date)}</span>
                            <span>Expired: ${formatDateShort(cert.expire_date)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                expiredSection.classList.add('hidden');
            }
        }

        // Get expiration badge for certification
        function getCertExpirationBadge(cert) {
            if (!cert.expire_date) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">No Expiration</span>';
            }

            const days = cert.days_until_expiration;
            if (days === null || days === undefined) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Current</span>';
            }

            if (days < 0) {
                return '<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-700">Expired</span>';
            } else if (days <= 90) {
                return `<span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">${days} days</span>`;
            } else {
                return '<span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">Current</span>';
            }
        }

        // Close Certification modal
        function closeCertModal() {
            document.getElementById('certModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Calculate alerts for a staff member - TIME OFF ONLY (no PMAP/ITR alerts)
        function calculateAlerts(staff) {
            const alerts = [];

            // Check PTO balance using accrual data
            const timeOffData = getTimeOffData(staff);
            const timeOffPercent = timeOffData.max > 0 ? (timeOffData.available / timeOffData.max) : 1;
            if (timeOffData.available < 0) {
                alerts.push({ level: 'red', message: `NEGATIVE time off balance (${timeOffData.available.toFixed(1)} / ${timeOffData.max.toFixed(0)} hours)` });
            } else if (timeOffPercent < 0.25) {
                alerts.push({ level: 'red', message: `Low time off balance (${timeOffData.available.toFixed(1)} / ${timeOffData.max.toFixed(0)} hours)` });
            } else if (timeOffPercent < 0.5) {
                alerts.push({ level: 'yellow', message: `Medium time off balance (${timeOffData.available.toFixed(1)} / ${timeOffData.max.toFixed(0)} hours)` });
            }

            // Determine overall level
            let level = 'green';
            if (alerts.some(a => a.level === 'red')) {
                level = 'red';
            } else if (alerts.some(a => a.level === 'yellow')) {
                level = 'yellow';
            }

            const text = level === 'green' ? 'Good' : level === 'yellow' ? 'Reminder' : 'Action Needed';

            return { level, text, items: alerts };
        }

        // Format birthday month/day from "MM-DD" string (no year sent from backend)
        function formatBirthdayMonthDay(monthDay) {
            if (!monthDay) return 'N/A';
            try {
                // monthDay is "MM-DD" format
                const parts = monthDay.split('-');
                if (parts.length !== 2) return monthDay;
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthIdx = parseInt(parts[0]) - 1;
                const day = parseInt(parts[1]);
                if (monthIdx >= 0 && monthIdx < 12) {
                    return `${months[monthIdx]} ${day}`;
                }
                return monthDay;
            } catch {
                return 'N/A';
            }
        }

        // Format short date
        function formatShortDate(dateStr) {
            if (!dateStr) return '&mdash;';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
            } catch {
                return '&mdash;';
            }
        }

        // Format date for display (short format)
        function formatDateShort(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return 'N/A';
            }
        }
    </script>
</body>
</html>
